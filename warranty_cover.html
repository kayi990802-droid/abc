<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>JINDE | 保固書封面生產</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;700;900&display=swap');
        
        body { background-color: #0f172a; font-family: 'Noto Sans TC', sans-serif; display: flex; flex-direction: column; overflow-x: hidden; }
        @media (min-width: 1024px) { body { flex-direction: row; overflow: hidden; height: 100vh; } }
        
        @page { size: A4; margin: 0; }
        
        /* 管理面板適配 */
        .admin-panel {
            width: 100%; background: #1e293b; padding: 20px; z-index: 1000;
            border-bottom: 1px solid rgba(255,255,255,0.1); flex-shrink: 0;
        }
        @media (min-width: 1024px) { 
            .admin-panel { width: 360px; height: 100vh; overflow-y: auto; border-right: 1px solid rgba(255,255,255,0.1); border-bottom: none; padding: 30px; } 
        }

        /* 預覽區域與 A4 縮放邏輯 */
        .preview-area { 
            flex-grow: 1; padding: 20px; display: flex; justify-content: center; 
            background: #334155; overflow: hidden;
        }
        @media (min-width: 1024px) { .preview-area { height: 100vh; overflow-y: auto; padding: 40px; } }
        
        .a4-page {
            width: 210mm; height: 297mm;
            background: white; position: relative; display: flex;
            flex-direction: column; align-items: center; justify-content: center;
            box-shadow: 0 0 50px rgba(0,0,0,0.5); flex-shrink: 0;
            transform-origin: top center;
        }

        /* 手機預覽縮放核心：根據螢幕寬度縮放 A4 紙張 */
        @media (max-width: 1023px) {
            .a4-page { transform: scale(0.38); margin-bottom: -180mm; } /* 縮小顯示 */
        }
        @media (max-width: 480px) {
            .a4-page { transform: scale(0.3); margin-bottom: -200mm; }
        }

        .cover-logo { width: 100mm; max-height: 100mm; object-fit: contain; margin-bottom: 25mm; }
        .cover-title { font-size: 32pt; font-weight: 900; letter-spacing: 0.25em; margin-bottom: 40mm; color: #1a222d; text-align: center; padding: 0 20mm; line-height: 1.5; }
        .cover-footer { position: absolute; bottom: 30mm; text-align: center; color: #475569; width: 100%; }

        /* 防止手機輸入框自動縮放 */
        input, textarea, select { font-size: 16px !important; }

        @media print {
            body { background: none; display: block; overflow: visible; }
            .no-print { display: none !important; }
            .preview-area { padding: 0; overflow: visible; display: block; background: white; }
            .a4-page { transform: scale(1) !important; margin: 0 !important; box-shadow: none; width: 210mm; height: 297mm; }
        }
    </style>
</head>
<body>
    <div class="no-print admin-panel text-white">
        <div class="flex justify-between items-center mb-4 lg:mb-6">
            <a href="warranty.html" class="text-slate-400 hover:text-teal-400 transition-all text-sm">
                <i class="fas fa-chevron-left mr-1"></i> 返回
            </a>
            <span id="logout-timer" class="text-[10px] font-mono text-rose-400 border border-rose-400/30 px-2 py-1 rounded">30:00</span>
        </div>

        <h2 class="text-xl lg:text-2xl font-black text-teal-400 mb-6">封面生產器</h2>

        <div class="space-y-4 lg:space-y-6">
            <div class="bg-slate-800 p-3 rounded-xl border border-teal-900/50">
                <label class="block text-[10px] font-bold text-teal-500 mb-2 uppercase tracking-widest">案場選擇</label>
                <select id="projectSelect" onchange="applyProjectTitle()" class="w-full bg-slate-900 border-none rounded-lg p-3 text-sm text-white focus:ring-1 focus:ring-teal-500 outline-none">
                    <option value="">-- 手動輸入 --</option>
                </select>
            </div>

            <div>
                <label class="block text-[10px] text-slate-400 mb-2 font-bold uppercase tracking-widest">1. 上傳 LOGO</label>
                <input type="file" id="logo_input" class="text-xs file:bg-slate-700 file:text-white file:border-0 file:rounded-md file:px-2 file:py-1 cursor-pointer w-full" onchange="loadCover(event)">
            </div>

            <div>
                <label class="block text-[10px] text-slate-400 mb-2 font-bold uppercase tracking-widest">2. 標題文字</label>
                <textarea id="in_title" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-sm h-24 focus:border-teal-500 outline-none text-white leading-relaxed" oninput="sync()">工程保固證明書</textarea>
            </div>

            <div>
                <label class="block text-[10px] text-slate-400 mb-2 font-bold uppercase tracking-widest">3. 底部通訊</label>
                <textarea id="in_info" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-[11px] h-20 focus:border-teal-500 outline-none text-white" oninput="sync()">地址：台中市北屯區山西路二段 250 號&#10;專業 · 智能 · 細心 · 責任</textarea>
            </div>

            <div class="pt-2">
                <button onclick="doPrint()" class="w-full bg-teal-500 py-4 rounded-xl font-black text-lg shadow-lg hover:bg-teal-400 active:scale-95 transition-all flex items-center justify-center gap-2">
                    <i class="fas fa-file-pdf"></i> 生成 PDF 封面
                </button>
            </div>
        </div>
    </div>

    <div class="preview-area">
        <div class="a4-page" id="capture-area">
            <img id="cover_img" src="" class="cover-logo" style="display:none;">
            <h2 id="out_title" class="cover-title whitespace-pre-line">工程保固證明書</h2>
            <div id="out_info" class="cover-footer whitespace-pre-line text-sm leading-loose tracking-[0.3em] font-medium">
                地址：台中市北屯區山西路二段 250 號
                專業 · 智能 · 細心 · 責任
            </div>
        </div>
    </div>

    <script>
        const S_URL = 'https://wdpxgichzvfebhlukbrl.supabase.co';
        const S_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndkcHhnaWNoenZmZWJobHVrYnJsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkwMjExMzQsImV4cCI6MjA4NDU5NzEzNH0.--85I0A-7WKt0P-ex1Zdnb8UVspuMNshzQtNaLedKq0';
        const _supabase = supabase.createClient(S_URL, S_KEY);

        let timeLeft = 30 * 60;

        async function init() {
            startTimer();
            const { data } = await _supabase.from('projects').select('*').order('created_at', { ascending: false });
            if (data) {
                const select = document.getElementById('projectSelect');
                data.forEach(p => {
                    const opt = document.createElement('option');
                    opt.value = p.name;
                    opt.text = p.name;
                    select.add(opt);
                });
            }
        }

        function applyProjectTitle() {
            const val = document.getElementById('projectSelect').value;
            if(val) {
                document.getElementById('in_title').value = val + "\n工程保固證明書";
                sync();
            }
        }

        function loadCover(e) {
            const out = document.getElementById('cover_img');
            if(e.target.files[0]) {
                out.src = URL.createObjectURL(e.target.files[0]);
                out.style.display = 'block';
            }
        }

        function sync() {
            document.getElementById('out_title').innerText = document.getElementById('in_title').value;
            document.getElementById('out_info').innerText = document.getElementById('in_info').value;
        }

        function doPrint() {
            const title = document.getElementById('projectSelect').value || "自定義";
            const date = new Date().toISOString().slice(0,10);
            document.title = `保固書封面_${title}_${date}`;
            window.print();
        }

        function startTimer() {
            const timerObj = document.getElementById('logout-timer');
            setInterval(() => {
                let m = Math.floor(timeLeft / 60);
                let s = timeLeft % 60;
                timerObj.innerText = `${m}:${s < 10 ? '0' : ''}${s}`;
                if (timeLeft <= 0) location.href = 'index.html';
                timeLeft--;
            }, 1000);
            ['mousedown', 'touchstart'].forEach(e => document.addEventListener(e, () => timeLeft = 30 * 60));
        }

        window.onload = init;
    </script>
</body>
</html>
