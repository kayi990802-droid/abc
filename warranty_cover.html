<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>JINDE | 保固書封面生產</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=Noto+Sans+TC:wght@300;400;700;900&display=swap');
        
        :root { --primary: #0d9488; --slate-dark: #1a222d; }
        body { background-color: #0f172a; font-family: 'Inter', 'Noto Sans TC', sans-serif; display: flex; flex-direction: column; overflow-x: hidden; margin: 0; }
        @media (min-width: 1024px) { body { flex-direction: row; overflow: hidden; height: 100vh; } }
        
        @page { size: A4; margin: 0; }

        /* 左側控制面板 */
        .admin-panel {
            width: 100%; background: var(--slate-dark); padding: 24px; z-index: 1000;
            border-bottom: 1px solid rgba(255,255,255,0.1); flex-shrink: 0;
            display: flex; flex-direction: column;
        }
        @media (min-width: 1024px) { 
            .admin-panel { width: 380px; height: 100vh; overflow-y: auto; border-right: 1px solid rgba(255,255,255,0.1); border-bottom: none; padding: 40px; } 
        }

        /* 工具箱快捷入口樣式 */
        .toolbox-entry {
            background: linear-gradient(135deg, rgba(13, 148, 136, 0.1) 0%, rgba(26, 34, 45, 1) 100%);
            border: 1px dashed rgba(13, 148, 136, 0.3); border-radius: 16px;
            padding: 20px; margin-top: 30px; transition: 0.3s; cursor: pointer;
        }
        .toolbox-entry:hover { border-color: var(--primary); background: rgba(13, 148, 136, 0.15); }

        .glass-input {
            background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1);
            color: white; border-radius: 12px; padding: 12px 16px; width: 100%;
            transition: all 0.3s; outline: none;
        }
        .glass-input:focus { border-color: var(--primary); background: rgba(255,255,255,0.06); box-shadow: 0 0 0 4px rgba(13, 148, 136, 0.1); }

        /* 預覽區域 */
        .preview-area { 
            flex-grow: 1; padding: 20px; display: flex; justify-content: center; 
            background: radial-gradient(circle at center, #334155 0%, #0f172a 100%); overflow: hidden;
        }
        @media (min-width: 1024px) { .preview-area { height: 100vh; overflow-y: auto; padding: 60px; } }

        .a4-page {
            width: 210mm; height: 297mm; background: white; position: relative; 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            box-shadow: 0 40px 100px rgba(0,0,0,0.6); flex-shrink: 0; transform-origin: top center;
        }

        @media (max-width: 1023px) { .a4-page { transform: scale(0.38); margin-bottom: -180mm; } }
        @media (max-width: 480px) { .a4-page { transform: scale(0.32); margin-bottom: -200mm; } }

        .cover-logo { width: 90mm; max-height: 90mm; object-fit: contain; margin-bottom: 20mm; }
        .cover-title { font-size: 34pt; font-weight: 900; letter-spacing: 0.3em; margin-bottom: 45mm; color: #1a222d; text-align: center; padding: 0 25mm; line-height: 1.6; }
        .cover-footer { position: absolute; bottom: 35mm; text-align: center; color: #64748b; width: 100%; border-top: 1px solid #f1f5f9; padding-top: 10mm; }

        input, textarea, select { font-size: 16px !important; }

        @media print {
            body { background: none; display: block; overflow: visible; }
            .no-print { display: none !important; }
            .preview-area { padding: 0; overflow: visible; display: block; background: white; }
            .a4-page { transform: scale(1) !important; margin: 0 !important; box-shadow: none; width: 210mm; height: 297mm; }
        }
    </style>
</head>
<body>
    <div class="no-print admin-panel text-white">
        <div class="flex justify-between items-center mb-8">
            <a href="warranty.html" class="text-slate-500 hover:text-teal-400 transition-all text-xs font-black uppercase tracking-widest">
                <i class="fas fa-arrow-left mr-2"></i> Back
            </a>
            <span id="logout-timer" class="text-[10px] font-black font-mono text-rose-400 bg-rose-400/10 px-3 py-1 rounded-full">30:00</span>
        </div>

        <div class="mb-8">
            <h2 class="text-2xl font-black text-white tracking-tighter italic">COVER<span class="text-teal-500">.</span></h2>
            <p class="text-[10px] font-bold text-slate-500 uppercase tracking-[0.3em] mt-1">保固封面生產器</p>
        </div>

        <div class="space-y-6 flex-grow">
            <div class="space-y-2">
                <label class="text-[10px] font-black text-teal-500 uppercase tracking-widest ml-1">案場選擇</label>
                <select id="projectSelect" onchange="applyProjectTitle()" class="glass-input appearance-none cursor-pointer">
                    <option value="">-- 手動輸入模式 --</option>
                </select>
            </div>

            <div class="space-y-2">
                <label class="text-[10px] font-black text-slate-500 uppercase tracking-widest ml-1">1. 上傳 LOGO</label>
                <input type="file" id="logo_input" class="text-[10px] file:bg-teal-600 file:text-white file:border-0 file:rounded-lg file:px-4 file:py-2 file:mr-4 file:font-black cursor-pointer w-full" onchange="loadCover(event)">
            </div>

            <div class="space-y-2">
                <label class="text-[10px] font-black text-slate-500 uppercase tracking-widest ml-1">2. 封面文字</label>
                <textarea id="in_title" class="glass-input h-24 leading-relaxed" oninput="sync()">工程保固證明書</textarea>
            </div>

            <div class="space-y-2">
                <label class="text-[10px] font-black text-slate-500 uppercase tracking-widest ml-1">3. 底部資訊</label>
                <textarea id="in_info" class="glass-input h-20 text-[11px]" oninput="sync()">地址：台中市北屯區山西路二段 250 號&#10;專業 · 智能 · 細心 · 責任</textarea>
            </div>

            <button onclick="doPrint()" class="w-full bg-teal-600 py-4 rounded-2xl font-black text-lg shadow-2xl hover:bg-teal-500 active:scale-95 transition-all flex items-center justify-center gap-3">
                <i class="fas fa-print"></i> 生成並列印
            </button>
        </div>

        <div class="toolbox-entry group" onclick="location.href='toolbox.html'">
            <div class="flex items-center gap-4">
                <div class="w-10 h-10 rounded-xl bg-teal-500/20 flex items-center justify-center text-teal-500 group-hover:bg-teal-500 group-hover:text-white transition-all">
                    <i class="fas fa-tools"></i>
                </div>
                <div>
                    <h4 class="text-xs font-black text-white">錦德 PDF 工具箱</h4>
                    <p class="text-[9px] text-slate-500 font-bold uppercase mt-1 tracking-tighter">合併 / 壓縮 / 浮水印</p>
                </div>
                <i class="fas fa-chevron-right ml-auto text-slate-700 text-xs"></i>
            </div>
        </div>
    </div>

    <div class="preview-area">
        <div class="a4-page" id="capture-area">
            <img id="cover_img" src="" class="cover-logo" style="display:none;">
            <h2 id="out_title" class="cover-title whitespace-pre-line italic">工程保固證明書</h2>
            <div id="out_info" class="cover-footer whitespace-pre-line text-[11pt] leading-[2.5] tracking-[0.4em] font-medium">
                地址：台中市北屯區山西路二段 250 號
                專業 · 智能 · 細心 · 責任
            </div>
        </div>
    </div>

    <script>
        const S_URL = 'https://wdpxgichzvfebhlukbrl.supabase.co';
        const S_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndkcHhnaWNoenZmZWJobHVrYnJsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkwMjExMzQsImV4cCI6MjA4NDU5NzEzNH0.--85I0A-7WKt0P-ex1Zdnb8UVspuMNshzQtNaLedKq0';
        const _supabase = supabase.createClient(S_URL, S_KEY);
        let timeLeft = 30 * 60;

        async function init() {
            startTimer();
            const { data } = await _supabase.from('projects').select('*').order('created_at', { ascending: false });
            if (data) {
                const select = document.getElementById('projectSelect');
                data.forEach(p => {
                    const opt = document.createElement('option');
                    opt.value = p.name;
                    opt.text = p.name;
                    select.add(opt);
                });
            }
        }

        function applyProjectTitle() {
            const val = document.getElementById('projectSelect').value;
            if(val) {
                document.getElementById('in_title').value = val + "\n工程保固證明書";
                sync();
            }
        }

        function loadCover(e) {
            const out = document.getElementById('cover_img');
            if(e.target.files[0]) {
                out.src = URL.createObjectURL(e.target.files[0]);
                out.style.display = 'block';
            }
        }

        function sync() {
            document.getElementById('out_title').innerText = document.getElementById('in_title').value;
            document.getElementById('out_info').innerText = document.getElementById('in_info').value;
        }

        function doPrint() {
            const title = document.getElementById('projectSelect').value || "自定義";
            const date = new Date().toISOString().slice(0,10);
            document.title = `保固書封面_${title}_${date}`;
            window.print();
        }

        function startTimer() {
            const timerObj = document.getElementById('logout-timer');
            setInterval(() => {
                let m = Math.floor(timeLeft / 60);
                let s = timeLeft % 60;
                timerObj.innerText = `${m}:${s < 10 ? '0' : ''}${s}`;
                if (timeLeft <= 0) location.href = 'index.html';
                timeLeft--;
            }, 1000);
            ['mousedown', 'touchstart'].forEach(e => document.addEventListener(e, () => timeLeft = 30 * 60));
        }

        window.onload = init;
    </script>
</body>
</html>
