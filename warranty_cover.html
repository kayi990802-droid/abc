<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>JINDE | 保固書封面生產</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;700;900&display=swap');
        body { background-color: #0f172a; font-family: 'Noto Sans TC', sans-serif; display: flex; overflow: hidden; }
        @page { size: A4; margin: 0; }
        
        .admin-panel {
            width: 360px; height: 100vh;
            background: rgba(30, 41, 59, 1);
            padding: 30px; z-index: 1000; border-right: 1px solid rgba(255,255,255,0.1);
            overflow-y: auto; flex-shrink: 0;
        }

        .preview-area { flex-grow: 1; height: 100vh; overflow-y: auto; padding: 40px; display: flex; justify-content: center; background: #334155; }
        
        /* A4 紙張模擬 */
        .a4-page {
            width: 210mm; height: 297mm;
            background: white; position: relative; display: flex;
            flex-direction: column; align-items: center; justify-content: center;
            box-shadow: 0 0 50px rgba(0,0,0,0.5); flex-shrink: 0;
        }

        .cover-logo { width: 100mm; max-height: 100mm; object-fit: contain; margin-bottom: 25mm; }
        .cover-title { font-size: 32pt; font-weight: 900; letter-spacing: 0.25em; margin-bottom: 40mm; color: #1a222d; text-align: center; padding: 0 20mm; line-height: 1.5; }
        .cover-footer { position: absolute; bottom: 30mm; text-align: center; color: #475569; width: 100%; }

        .back-home {
            display: flex; align-items: center; gap: 8px; color: #94a3b8;
            font-size: 0.875rem; font-weight: 600; margin-bottom: 2rem;
            transition: 0.3s; cursor: pointer; text-decoration: none;
        }
        .back-home:hover { color: #2dd4bf; transform: translateX(-4px); }

        @media print {
            body { background: none; overflow: visible; }
            .no-print { display: none !important; }
            .preview-area { padding: 0; overflow: visible; display: block; background: white; }
            .a4-page { margin: 0; box-shadow: none; width: 210mm; height: 297mm; }
        }
    </style>
</head>
<body>
    <div class="no-print admin-panel text-white">
        <a href="warranty.html" class="back-home">
            <i class="fas fa-chevron-left"></i> 返回保固中控
        </a>
        
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-black text-teal-400">封面生產器</h2>
            <span id="logout-timer" class="text-[10px] font-mono text-rose-400 border border-rose-400/30 px-2 py-1 rounded">30:00</span>
        </div>

        <div class="space-y-6">
            <div class="bg-slate-800 p-4 rounded-xl border border-teal-900/50">
                <label class="block text-[10px] font-bold text-teal-500 mb-2 uppercase tracking-widest">快速載入案場</label>
                <select id="projectSelect" onchange="applyProjectTitle()" class="w-full bg-slate-900 border-none rounded-lg p-3 text-sm focus:ring-1 focus:ring-teal-500 outline-none">
                    <option value="">-- 手動輸入標題 --</option>
                </select>
            </div>

            <div>
                <label class="block text-xs text-slate-400 mb-2 font-bold uppercase tracking-widest">1. 公司形象 Logo</label>
                <input type="file" id="logo_input" class="text-xs file:bg-slate-700 file:text-white file:border-0 file:rounded-md file:px-3 file:py-2 hover:file:bg-teal-600 cursor-pointer w-full" onchange="loadCover(event)">
                <p class="text-[10px] text-slate-500 mt-2">建議使用去背 PNG 檔，寬度至少 1200px</p>
            </div>

            <div>
                <label class="block text-xs text-slate-400 mb-2 font-bold uppercase tracking-widest">2. 封面標題內容</label>
                <textarea id="in_title" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-sm h-32 focus:border-teal-500 outline-none leading-relaxed" oninput="sync()">工程保固證明書</textarea>
            </div>

            <div>
                <label class="block text-xs text-slate-400 mb-2 font-bold uppercase tracking-widest">3. 底部資訊</label>
                <textarea id="in_info" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-[11px] h-24 focus:border-teal-500 outline-none" oninput="sync()">地址：台中市北屯區山西路二段 250 號&#10;專業 · 智能 · 細心 · 責任</textarea>
            </div>

            <div class="pt-4">
                <button onclick="doPrint()" class="w-full bg-teal-500 py-4 rounded-xl font-black text-lg shadow-lg hover:bg-teal-400 active:scale-95 transition-all flex items-center justify-center gap-3">
                    <i class="fas fa-print"></i> 列印正式封面
                </button>
                <p class="text-center text-[10px] text-slate-500 mt-4 italic">提示：列印目的地請選擇「另存為 PDF」</p>
            </div>
        </div>
    </div>

    <div class="preview-area">
        <div class="a4-page" id="capture-area">
            <img id="cover_img" src="" class="cover-logo" style="display:none;">
            <h2 id="out_title" class="cover-title whitespace-pre-line">工程保固證明書</h2>
            <div id="out_info" class="cover-footer whitespace-pre-line text-sm leading-loose tracking-[0.3em] font-medium">
                地址：台中市北屯區山西路二段 250 號
                專業 · 智能 · 細心 · 責任
            </div>
        </div>
    </div>

    <script>
        const S_URL = 'https://wdpxgichzvfebhlukbrl.supabase.co';
        const S_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndkcHhnaWNoenZmZWJobHVrYnJsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkwMjExMzQsImV4cCI6MjA4NDU5NzEzNH0.--85I0A-7WKt0P-ex1Zdnb8UVspuMNshzQtNaLedKq0';
        const _supabase = supabase.createClient(S_URL, S_KEY);

        let timeLeft = 30 * 60;

        async function init() {
            startTimer();
            // 從 projects 抓取資料
            const { data } = await _supabase.from('projects').select('*').order('created_at', { ascending: false });
            if (data) {
                const select = document.getElementById('projectSelect');
                data.forEach(p => {
                    const opt = document.createElement('option');
                    opt.value = p.name;
                    opt.text = p.name;
                    select.add(opt);
                });
            }
        }

        function applyProjectTitle() {
            const val = document.getElementById('projectSelect').value;
            if(val) {
                // 自動組合標題：案場名稱 + 換行 + 固定字樣
                document.getElementById('in_title').value = val + "\n工程保固證明書";
                sync();
            }
        }

        function loadCover(e) {
            const out = document.getElementById('cover_img');
            if(e.target.files[0]) {
                out.src = URL.createObjectURL(e.target.files[0]);
                out.style.display = 'block';
            }
        }

        function sync() {
            document.getElementById('out_title').innerText = document.getElementById('in_title').value;
            document.getElementById('out_info').innerText = document.getElementById('in_info').value;
        }

        // 執行列印並自動命名
        function doPrint() {
            const title = document.getElementById('projectSelect').value || "自定義";
            document.title = `保固書封面_${title}_${new Date().toISOString().slice(0,10)}`;
            window.print();
        }

        // 安全計時器
        function startTimer() {
            const timerObj = document.getElementById('logout-timer');
            setInterval(() => {
                let m = Math.floor(timeLeft / 60);
                let s = timeLeft % 60;
                timerObj.innerText = `${m}:${s < 10 ? '0' : ''}${s}`;
                if (timeLeft <= 0) location.href = 'index.html';
                timeLeft--;
            }, 1000);
            ['mousedown', 'keydown', 'touchstart'].forEach(e => document.addEventListener(e, () => timeLeft = 30 * 60));
        }

        window.onload = init;
    </script>
</body>
</html>
