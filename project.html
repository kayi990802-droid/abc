<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>JINDE | 工地管理系統</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // 【權限與自動登入逾時檢查】
        const MAX_IDLE_TIME = 30 * 60 * 1000; // 30 分鐘
        const lastActive = localStorage.getItem('jinde_last_active');
        const now = Date.now();

        if (localStorage.getItem('jinde_verified') !== 'true') {
            window.location.href = 'login.html';
        } else if (lastActive && (now - lastActive > MAX_IDLE_TIME)) {
            localStorage.clear();
            window.location.href = 'login.html';
        }
        localStorage.setItem('jinde_last_active', now);
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        body { background-color: #f8fafc; font-family: 'Noto Sans TC', sans-serif; height: 100vh; display: flex; overflow: hidden; }
        
        /* 側邊欄手機版響應式 */
        .sidebar { width: 280px; background: #0f172a; color: white; flex-shrink: 0; display: flex; flex-direction: column; transition: all 0.3s ease; }
        .main-content { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; }
        
        .project-card { background: white; border-radius: 16px; border: 1px solid #e2e8f0; transition: all 0.3s ease; }
        .project-card:hover { transform: translateY(-5px); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); border-color: #14b8a6; }
        
        .nav-link { display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-radius: 12px; transition: 0.2s; color: #94a3b8; font-weight: 600; cursor: pointer; }
        .nav-link:hover { background: #1e293b; color: white; }
        .nav-link.active { background: #14b8a6; color: white; }

        /* 手機版適配 */
        @media (max-width: 768px) {
            .sidebar { width: 70px; padding: 15px 10px !important; }
            .sidebar span, .sidebar p, .sidebar h1, .sidebar .nav-text { display: none; }
            .nav-link { justify-content: center; padding: 15px 0; }
            .nav-link i { font-size: 20px; }
            .main-content header { padding: 15px 20px; }
            .grid-container { grid-template-columns: 1fr !important; padding: 20px !important; }
        }
    </style>
</head>
<body>
    <aside class="sidebar p-6">
        <div class="mb-10 px-2">
            <h1 class="text-3xl font-black tracking-tighter">JINDE<span class="text-teal-400">.</span></h1>
            <p class="text-[10px] text-slate-500 uppercase tracking-widest mt-1">工程管理系統</p>
        </div>
        
        <nav class="space-y-2 flex-grow">
            <a href="index.html" class="nav-link">
                <i class="fas fa-home w-5"></i> <span class="nav-text">系統回首頁</span>
            </a>
            
            <div class="pt-4 pb-2 px-4 text-[10px] font-bold text-slate-500 uppercase nav-text">工程管理</div>
            <a href="project.html" class="nav-link active">
                <i class="fas fa-tasks w-5"></i> <span class="nav-text">案場清單</span>
            </a>
            <a href="quote_query.html" class="nav-link">
                <i class="fas fa-search-dollar w-5"></i> <span class="nav-text">報價紀錄查詢</span>
            </a>
            <a href="record.html" class="nav-link">
                <i class="fas fa-history w-5"></i> <span class="nav-text">保固紀錄查詢</span>
            </a>

            <div class="pt-4 pb-2 px-4 text-[10px] font-bold text-slate-500 uppercase nav-text">文件核發</div>
            <a href="warranty_content.html" class="nav-link">
                <i class="fas fa-file-signature w-5"></i> <span class="nav-text">核發保固書</span>
            </a>
        </nav>

        <div id="db-status" class="bg-slate-900 p-4 rounded-xl text-[10px] font-mono mt-auto">
            <span class="text-slate-500 italic nav-text">系統連線中...</span>
        </div>
    </aside>

    <main class="main-content">
        <header class="bg-white border-b border-slate-200 px-6 md:px-10 py-5 flex justify-between items-center shadow-sm">
            <div>
                <nav class="flex text-slate-400 text-[10px] font-bold uppercase mb-1">
                    <a href="index.html" class="hover:text-teal-500">HOME</a>
                    <span class="mx-2">/</span>
                    <span class="text-slate-800">PROJECTS</span>
                </nav>
                <h2 class="font-black text-slate-800 text-xl">案場管理總覽</h2>
            </div>
            
            <button onclick="openModal()" class="bg-slate-900 hover:bg-teal-600 text-white w-10 h-10 md:w-auto md:px-6 md:py-3 rounded-xl font-bold text-xs transition shadow-lg active:scale-95 flex items-center justify-center">
                <i class="fas fa-plus"></i> <span class="hidden md:inline ml-2">建立新案場</span>
            </button>
        </header>

        <div class="p-6 md:p-10 overflow-y-auto">
            <div id="projectGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 md:gap-8 grid-container">
                </div>
            <div id="empty-state" class="hidden text-center py-20 text-slate-300">
                <i class="fas fa-folder-open text-5xl mb-4"></i>
                <p>目前尚無案場資料</p>
            </div>
        </div>
    </main>

    <div id="projectModal" class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 flex items-center justify-center p-6">
        <div class="bg-white rounded-3xl w-full max-w-md p-8 shadow-2xl relative">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-black text-slate-800">新增案場</h3>
                <button onclick="closeModal()" class="text-slate-400 hover:text-slate-600"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="space-y-5">
                <div>
                    <label class="text-xs font-bold text-slate-400 block mb-2 uppercase">案場名稱</label>
                    <input type="text" id="p_name" placeholder="例如：復興路王先生家止漏" class="w-full bg-slate-50 border-2 border-slate-100 rounded-xl p-4 outline-none focus:border-teal-500 transition font-bold">
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-400 block mb-2 uppercase">合約 PDF 附件</label>
                    <input type="file" id="p_file" accept=".pdf" class="block w-full text-xs text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:bg-teal-50 file:text-teal-700 hover:file:bg-teal-100">
                </div>
                <button id="saveBtn" onclick="saveProject()" class="w-full bg-teal-600 py-4 text-white rounded-2xl font-black shadow-xl shadow-teal-500/20 hover:bg-teal-500 transition mt-4">確認存檔並上傳</button>
            </div>
        </div>
    </div>

    <script>
        const S_URL = 'https://wdpxgichzvfebhlukbrl.supabase.co';
        const S_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndkcHhnaWNoenZmZWJobHVrYnJsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkwMjExMzQsImV4cCI6MjA4NDU5NzEzNH0.--85I0A-7WKt0P-ex1Zdnb8UVspuMNshzQtNaLedKq0';
        const _supabase = supabase.createClient(S_URL, S_KEY);

        // --- 自動登出計時器 ---
        let idleTimer;
        function resetIdleTimer() {
            clearTimeout(idleTimer);
            localStorage.setItem('jinde_last_active', Date.now());
            idleTimer = setTimeout(() => {
                localStorage.clear();
                window.location.href = 'login.html';
            }, 30 * 60 * 1000); // 30分鐘
        }
        window.onmousemove = resetIdleTimer;
        window.onkeypress = resetIdleTimer;

        async function fetchProjects() {
            const { data, error } = await _supabase.from('projects').select('*').order('created_at', { ascending: false });
            const grid = document.getElementById('projectGrid');
            const empty = document.getElementById('empty-state');
            const statusDiv = document.getElementById('db-status');

            if (error || !data || data.length === 0) {
                grid.innerHTML = "";
                empty.classList.remove('hidden');
                statusDiv.innerHTML = `<span class="text-rose-400">● 查無資料</span>`;
                return;
            }

            empty.classList.add('hidden');
            statusDiv.innerHTML = `<span class="text-emerald-400">● 連線正常</span> <span class="nav-text">(${data.length} 案場)</span>`;
            
            grid.innerHTML = data.map(p => `
                <div class="project-card p-6">
                    <div class="flex justify-between items-start mb-10">
                        <div class="flex-grow pr-4">
                            <h3 class="font-black text-slate-800 text-lg break-words">${p.name}</h3>
                            <p class="text-[10px] font-mono text-slate-400 uppercase mt-1 tracking-widest">${p.project_no || 'PJ-TEMP'}</p>
                        </div>
                        ${p.file_url ? `
                            <a href="${p.file_url}" target="_blank" class="shrink-0 w-10 h-10 bg-slate-900 text-white rounded-xl flex items-center justify-center hover:bg-teal-500 shadow-md transition">
                                <i class="fas fa-file-pdf"></i>
                            </a>
                        ` : `<div class="shrink-0 w-10 h-10 bg-slate-50 text-slate-200 rounded-xl flex items-center justify-center italic text-[9px]">無附件</div>`}
                    </div>
                    <div class="flex justify-end pt-4 border-t border-slate-50">
                        <button onclick="deleteProject('${p.id}')" class="text-slate-300 hover:text-rose-500 transition p-2">
                            <i class="fas fa-trash-alt text-sm"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        async function saveProject() {
            const name = document.getElementById('p_name').value;
            const fileInput = document.getElementById('p_file');
            const saveBtn = document.getElementById('saveBtn');

            if (!name) return alert("請輸入案場名稱");
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> 正在存檔...';

            let fileUrl = null;
            try {
                if (fileInput.files.length > 0) {
                    const file = fileInput.files[0];
                    const fileName = `PDF_${Date.now()}`;
                    const { data: upData, error: upErr } = await _supabase.storage.from('project-files').upload(fileName, file);
                    if (upErr) throw upErr;
                    const { data: urlData } = _supabase.storage.from('project-files').getPublicUrl(fileName);
                    fileUrl = urlData.publicUrl;
                }

                const { error: insErr } = await _supabase.from('projects').insert([{
                    name: name,
                    project_no: "PJ-" + Date.now().toString().slice(-6),
                    file_url: fileUrl
                }]);

                if (insErr) throw insErr;
                closeModal();
                document.getElementById('p_name').value = "";
                document.getElementById('p_file').value = "";
                fetchProjects();
            } catch (err) {
                alert("錯誤：" + err.message);
            } finally {
                saveBtn.disabled = false;
                saveBtn.innerText = "確認存檔並上傳";
            }
        }

        async function deleteProject(id) {
            if (!confirm("確定刪除此案場？此操作不可恢復。")) return;
            const { error } = await _supabase.from('projects').delete().eq('id', id);
            if (error) alert("刪除失敗");
            fetchProjects();
        }

        function openModal() { document.getElementById('projectModal').classList.remove('hidden'); }
        function closeModal() { document.getElementById('projectModal').classList.add('hidden'); }
        
        window.onload = () => {
            fetchProjects();
            resetIdleTimer();
        };
    </script>
</body>
</html>
