<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>JINDE | 雲端保固系統核心版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=Noto+Serif+TC:wght@400;700;900&family=Noto+Sans+TC:wght@400;700;900&display=swap');
        
        :root { --primary: #0d9488; --slate-dark: #1a222d; }
        body { background-color: #0f172a; margin: 0; padding: 0; display: flex; flex-direction: column; height: 100vh; font-family: 'Inter', 'Noto Sans TC', sans-serif; }
        
        @media (min-width: 1024px) { body { flex-direction: row; } }
        
        @page { size: A4; margin: 0; }

        .admin-panel { width: 100%; background: var(--slate-dark); padding: 24px; z-index: 1000; overflow-y: auto; color: white; border-bottom: 1px solid rgba(255,255,255,0.1); }
        @media (min-width: 1024px) { .admin-panel { width: 400px; height: 100vh; border-right: 1px solid rgba(255,255,255,0.1); border-bottom: none; padding: 40px; } }

        .glass-input { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: white; border-radius: 12px; padding: 14px; width: 100%; transition: all 0.3s; outline: none; font-size: 16px !important; }
        .glass-input:focus { border-color: var(--primary); background: rgba(255,255,255,0.08); }

        .preview-area { flex-grow: 1; overflow-y: auto; padding: 10px; display: flex; justify-content: center; background: radial-gradient(circle at center, #334155 0%, #0f172a 100%); }
        @media (min-width: 1024px) { .preview-area { padding: 50px; } }

        .a4-page { width: 210mm; height: 297mm; padding: 20mm 22mm; background: white; font-family: 'Noto Serif TC', serif; color: #1a1a1a; position: relative; box-sizing: border-box; box-shadow: 0 50px 100px rgba(0,0,0,0.5); flex-shrink: 0; transform-origin: top center; }

        @media (max-width: 1023px) { .a4-page { transform: scale(0.42); margin-bottom: -170mm; } }
        @media (max-width: 500px) { .a4-page { transform: scale(0.32); margin-bottom: -200mm; } }

        .page-header { border-bottom: 2pt solid #000; padding-bottom: 10px; display: flex; justify-content: space-between; align-items: flex-end; }
        .main-title { font-size: 38pt; font-weight: 900; text-align: center; margin: 35pt 0; letter-spacing: 0.6em; color: #000; }
        .content-body { font-size: 14pt; line-height: 2.2; text-align: justify; margin-bottom: 25pt; }
        .underline-input { font-weight: 900; border-bottom: 1.5pt solid #000; padding: 0 8px; display: inline-block; min-width: 100px; text-align: center; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        td { border: 1.2pt solid #000; padding: 10pt; font-size: 12pt; color: #000; vertical-align: middle; }
        .bg-gray { background-color: #f8fafc; font-weight: 700; width: 110px; text-align: center; font-family: 'Noto Sans TC', sans-serif; }

        #logo_preview { position: absolute; top: 43mm; right: 22mm; max-width: 50mm; max-height: 25mm; display: none; filter: grayscale(1); opacity: 0.8; }
        #seal_preview { position: absolute; bottom: 105px; right: 140px; width: 140px; display: none; transform: rotate(-10deg); z-index: 10; opacity: 0.9; pointer-events: none; mix-blend-mode: multiply; }

        @media print { 
            body { background: none; flex-direction: column; overflow: visible; } 
            .no-print { display: none !important; } 
            .preview-area { padding: 0; display: block; overflow: visible; background: white; } 
            .a4-page { transform: scale(1) !important; margin: 0 auto !important; box-shadow: none; border: none; } 
        }
    </style>
</head>
<body>
    <div class="no-print admin-panel">
        <div class="flex justify-between items-center mb-8">
            <a href="warranty.html" class="text-slate-500 hover:text-teal-400 text-xs font-black uppercase tracking-widest transition-all">
                <i class="fas fa-arrow-left mr-1"></i> 返回列表
            </a>
            <span id="logout-timer" class="text-[10px] font-black font-mono text-rose-400 bg-rose-400/10 px-3 py-1 rounded-full">30:00</span>
        </div>

        <div class="mb-6">
            <h2 class="text-2xl font-black text-white italic tracking-tighter">JINDE<span class="text-teal-500">.</span></h2>
            <p class="text-[10px] font-bold text-slate-500 uppercase tracking-[0.3em] mt-1">服務保固書生產系統</p>
        </div>

        <div class="space-y-4">
            <div class="grid grid-cols-2 gap-3">
                <div class="space-y-1">
                    <label class="text-[10px] text-teal-500 font-black uppercase tracking-widest">Logo 上傳</label>
                    <input type="file" class="text-[10px] w-full" onchange="loadFile(event, 'logo_preview')">
                </div>
                <div class="space-y-1">
                    <label class="text-[10px] text-rose-400 font-black uppercase tracking-widest">公司用印</label>
                    <input type="file" class="text-[10px] w-full" onchange="loadFile(event, 'seal_preview')">
                </div>
            </div>

            <div class="space-y-1">
                <label class="text-[10px] text-slate-500 font-black uppercase tracking-widest">客戶名稱</label>
                <input type="text" id="in_client" placeholder="業主姓名" class="glass-input" oninput="sync()">
            </div>

            <div class="space-y-1">
                <label class="text-[10px] text-slate-500 font-black uppercase tracking-widest">案場名稱與地址</label>
                <textarea id="in_p_name" rows="2" placeholder="詳細工程地點" class="glass-input" oninput="sync()"></textarea>
            </div>

            <div class="grid grid-cols-2 gap-3">
                <div class="space-y-1">
                    <label class="text-[10px] text-slate-500 font-black uppercase tracking-widest">完工日期</label>
                    <input type="date" id="in_date" class="glass-input" oninput="sync()">
                </div>
                <div class="space-y-1">
                    <label class="text-[10px] text-slate-500 font-black uppercase tracking-widest">保固年限</label>
                    <input type="number" id="in_years" value="3" class="glass-input" oninput="sync()">
                </div>
            </div>

            <div class="space-y-1">
                <label class="text-[10px] text-slate-500 font-black uppercase tracking-widest">施工項目類別</label>
                <select id="in_work_type" class="glass-input appearance-none" onchange="sync()">
                    <option value="高壓灌注止漏工法">高壓灌注止漏工法</option>
                    <option value="複合式防水工程">複合式防水工程</option>
                    <option value="外牆滲漏修繕">外牆滲漏修繕</option>
                    <option value="屋頂隔熱防水">屋頂隔熱防水</option>
                </select>
            </div>

            <div class="pt-4">
                <button id="saveBtn" onclick="saveAndPrint()" class="w-full bg-teal-600 hover:bg-teal-500 text-white py-4 rounded-xl font-black text-lg shadow-2xl transition-all flex items-center justify-center gap-3 active:scale-95">
                    <i class="fas fa-save"></i> 儲存並列印保固書
                </button>
            </div>
        </div>
    </div>

    <div class="preview-area">
        <div class="a4-page" id="print-content">
            <div class="page-header">
                <div class="text-[14pt] font-bold tracking-[0.5em] font-sans">專 業 · 態 度 · 細 心 · 責 任</div>
                <div class="text-[10pt] italic text-gray-400 font-sans tracking-tighter uppercase">Jinde Engineering Hub</div>
            </div>
            <div class="border-b-[1.5pt] border-black mt-1 mb-10"></div>
            
            <img id="logo_preview" src="">
            <h1 class="main-title italic">服務保固書</h1>
            
            <div class="content-body">
                茲承攬 <span id="out_client" class="underline-input italic">未填寫</span> 之 <span id="out_p_name" class="underline-input italic">未填寫</span> <span id="out_work_type" class="font-bold underline-input">高壓灌注止漏工法</span>。本公司承諾對施工品質負完全責任，若於保固期間內發生施工瑕疵導致之滲漏，本公司將負責無償修繕完成。
            </div>

            <table>
                <tr><td class="bg-gray">保固起始</td><td colspan="3" class="font-bold">自民國 <span class="d_y"></span> 年 <span class="d_m"></span> 月 <span class="d_d"></span> 日起。</td></tr>
                <tr><td class="bg-gray">保固截止</td><td colspan="3" class="font-bold text-rose-700">至民國 <span id="end_y"></span> 年 <span id="end_m"></span> 月 <span id="end_d"></span> 日止，共計 <span id="out_years">3</span> 年。</td></tr>
                <tr><td class="bg-gray">承攬廠商</td><td class="text-xl font-black">錦德工程行</td><td class="bg-gray">統一編號</td><td class="font-bold font-sans">80081612</td></tr>
                <tr><td class="bg-gray">負責人</td><td class="text-lg">王震昱</td><td class="bg-gray">聯絡電話</td><td class="font-bold font-sans">0963-696-032</td></tr>
                <tr><td class="bg-gray">通訊地址</td><td colspan="3" class="text-[11pt]">401 臺中市東區建德街 346 巷 7 號</td></tr>
            </table>

            <div class="absolute bottom-[40mm] left-[22mm] flex items-center gap-5 font-sans">
                <div class="border-[1.2pt] border-black p-1 bg-white"><img id="qr_img" src="" class="w-20 h-20"></div>
                <div class="text-[10pt] leading-snug">
                    <span class="font-black text-slate-800">數位保固驗證系統</span><br>
                    核發編號：<span id="doc_id" class="font-mono font-bold text-teal-700"></span><br>
                    <span class="text-gray-400 tracking-tighter uppercase text-[7pt] font-black">Authentic Guarantee & Verified</span>
                </div>
            </div>

            <img id="seal_preview" src="">
            <div class="absolute bottom-[40mm] right-[22mm] text-right font-sans">
                <p class="font-black text-[18pt] tracking-tight">中 華 民 國 <span class="d_y"></span> 年 <span class="d_m"></span> 月 <span class="d_d"></span> 日</p>
            </div>
        </div>
    </div>

    <script>
        const S_URL = 'https://wdpxgichzvfebhlukbrl.supabase.co';
        const S_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndkcHhnaWNoenZmZWJobHVrYnJsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkwMjExMzQsImV4cCI6MjA4NDU5NzEzNH0.--85I0A-7WKt0P-ex1Zdnb8UVspuMNshzQtNaLedKq0';
        const _supabase = supabase.createClient(S_URL, S_KEY);
        let timeLeft = 30 * 60;

        window.onload = () => {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('in_date').value = today;
            startTimer();
            sync();
        };

        function generateId() {
            const ts = new Date().getTime().toString().slice(-6);
            const rnd = Math.random().toString(36).substring(2, 5).toUpperCase();
            return `JD-${ts}-${rnd}`;
        }

        function startTimer() {
            const timerObj = document.getElementById('logout-timer');
            setInterval(() => {
                let m = Math.floor(timeLeft / 60);
                let s = timeLeft % 60;
                timerObj.innerText = `${m}:${s < 10 ? '0' : ''}${s}`;
                if (timeLeft <= 0) location.href = 'index.html';
                timeLeft--;
            }, 1000);
            ['mousedown', 'touchstart'].forEach(evt => document.addEventListener(evt, () => timeLeft = 30 * 60));
        }

        function loadFile(event, targetId) {
            const output = document.getElementById(targetId);
            if(event.target.files[0]) {
                output.src = URL.createObjectURL(event.target.files[0]);
                output.style.display = 'block';
            }
        }

        function sync() {
            const client = document.getElementById('in_client').value || "未填寫";
            const project = document.getElementById('in_p_name').value || "未填寫";
            const years = document.getElementById('in_years').value || 3;
            const workType = document.getElementById('in_work_type').value;

            document.getElementById('out_client').innerText = client;
            document.getElementById('out_p_name').innerText = project;
            document.getElementById('out_years').innerText = years;
            document.getElementById('out_work_type').innerText = workType;

            if(!window.docId) window.docId = generateId();
            document.getElementById('doc_id').innerText = window.docId;

            // QR Code 直接顯示保固內容摘要
            const qrSummary = `錦德工程保固驗證\n編號：${window.docId}\n客戶：${client}\n工程：${project}\n年限：${years}年`;
            document.getElementById('qr_img').src = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(qrSummary)}`;

            const dVal = document.getElementById('in_date').value;
            if(dVal) {
                const d = new Date(dVal);
                // 起始日
                document.querySelectorAll('.d_y').forEach(el => el.innerText = d.getFullYear() - 1911);
                document.querySelectorAll('.d_m').forEach(el => el.innerText = d.getMonth() + 1);
                document.querySelectorAll('.d_d').forEach(el => el.innerText = d.getDate());
                
                // 到期日計算
                const endD = new Date(d);
                endD.setFullYear(endD.getFullYear() + parseInt(years));
                document.getElementById('end_y').innerText = endD.getFullYear() - 1911;
                document.getElementById('end_m').innerText = endD.getMonth() + 1;
                document.getElementById('end_d').innerText = endD.getDate();
            }
        }

        async function saveAndPrint() {
            const client = document.getElementById('in_client').value;
            if(!client) return alert("請輸入客戶姓名！");
            if (!confirm("即將儲存並開啟列印，確定資料無誤？")) return;
            
            const btn = document.getElementById('saveBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 處理中...';

            try {
                const { error } = await _supabase.from('warranties').insert([{
                    doc_id: window.docId,
                    client_name: client,
                    project_name: document.getElementById('in_p_name').value,
                    warranty_years: parseInt(document.getElementById('in_years').value),
                    created_at: new Date(document.getElementById('in_date').value).toISOString()
                }]);

                if (error) {
                    if(error.code === '23505') {
                        window.docId = generateId();
                        sync();
                        throw new Error("編號重複，系統已自動更換，請再點擊一次按鈕。");
                    }
                    throw error;
                }

                window.print();
                window.docId = null; // 成功後清空 ID
                sync();
                
            } catch (err) {
                alert(err.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-save"></i> 儲存並列印保固書';
            }
        }
    </script>
</body>
</html>
