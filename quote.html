<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>JINDE | éŒ¦å¾·å·¥ç¨‹å ±åƒ¹ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #0f172a; margin: 0; color: #1e293b; }
        @media (min-width: 1024px) {
            body { display: flex; height: 100vh; overflow: hidden; }
            .admin-sidebar { width: 400px; height: 100vh; overflow-y: auto; background: #1e293b; color: white; padding: 24px; flex-shrink: 0; }
            .main-content { flex: 1; height: 100vh; overflow-y: auto; padding: 40px; background: #334155; display: flex; justify-content: center; }
            .a4-preview { width: 210mm; min-height: 297mm; }
        }
        .a4-preview { background: white; color: #1a1a1a; padding: 15mm 20mm; position: relative; box-shadow: 0 10px 25px rgba(0,0,0,0.3); display: flex; flex-direction: column; }
        input, textarea { color: #fff; background: #0f172a; border-radius: 8px; padding: 12px; width: 100%; border: 1px solid #334155; margin-bottom: 12px; }
        .preview-input { background: transparent !important; color: #000 !important; border: none !important; padding: 0 !important; font-weight: bold; outline: none !important; width: 100%; }
        .work-btn { background: #334155; border: 1px solid #475569; padding: 12px 8px; border-radius: 8px; font-size: 13px; font-weight: bold; color: #2dd4bf; transition: all 0.2s; text-align: left; }
        .photo-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 10px; }
        .photo-item { position: relative; width: 100%; height: 160px; }
        .photo-item img { width: 100%; height: 100%; object-fit: cover; border: 1px solid #eee; border-radius: 4px; }
        .del-btn { position: absolute; top: 5px; right: 5px; background: #ef4444; color: white; width: 22px; height: 22px; border-radius: 50%; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; z-index: 10; }
        .editable-area { border: 1px dashed #cbd5e1; padding: 8px; font-size: 12px; font-weight: bold; margin-bottom: 15px; min-height: 40px; white-space: pre-wrap; outline: none; color: #000; }
        .info-label { font-size: 11px; font-weight: 900; background: #000; color: #fff; padding: 2px 8px; display: inline-block; margin-bottom: 4px; font-style: italic; }
        .sig-container { margin-top: 40px; display: grid; grid-template-columns: 1fr 1fr; gap: 40px; text-align: center; }
        .sig-box { border-top: 2px solid #000; padding-top: 8px; font-size: 11px; font-weight: 900; position: relative; }
        #seal_img { position: absolute; bottom: 15px; left: 50%; transform: translateX(-50%); width: 110px; display: none; mix-blend-mode: multiply; pointer-events: none; }
        @media print { .no-print, .del-btn { display: none !important; } .editable-area { border: none !important; padding: 0; } body { background: white; } .a4-preview { box-shadow: none; width: 210mm; margin: 0; } }
    </style>
</head>
<body>
<div class="admin-sidebar no-print">
    <h2 class="text-2xl font-black text-teal-400 mb-6 italic">JINDE å¿«é€Ÿå ±åƒ¹</h2>
    <label class="block text-[11px] font-bold text-gray-400 mb-2 uppercase">å¿«æ·å·¥æ³•</label>
    <div class="grid grid-cols-1 gap-2 mb-6">
        <button class="work-btn" onclick="addPU()">ğŸ  å±‹é ‚æ²¹æ€§PUä¸‰å±¤</button>
        <button class="work-btn" onclick="addWaterWall()">ğŸ§± ç‰†é¢æ°´æ€§äº”å±¤</button>
        <button class="work-btn" onclick="addRow('é«˜å£“çŒæ³¨æ­¢æ¼å·¥æ³•')">ğŸ’‰ é«˜å£“çŒæ³¨æ­¢æ¼</button>
        <button class="work-btn" onclick="addRow('')">âœï¸ è‡ªå®šç¾©é …ç›®</button>
    </div>
    <label class="block text-[11px] font-bold text-gray-400 mb-2">æ–‡ä»¶ä¸Šå‚³</label>
    <div class="flex flex-col gap-2 mb-6 bg-slate-800 p-3 rounded-lg border border-slate-700">
        <input type="file" class="text-xs" onchange="loadImage(event, 'logo_img')" title="Logo">
        <input type="file" class="text-xs" multiple onchange="loadMultipleImages(event)" title="æ–½å·¥åœ–">
        <input type="file" class="text-xs" onchange="loadImage(event, 'seal_img')" title="è·ç« ">
    </div>
    <input type="text" id="in_name" placeholder="å®¢æˆ¶åç¨±" oninput="syncData()">
    <input type="text" id="in_addr" placeholder="æ–½å·¥åœ°å€" oninput="syncData()">
    <div class="bg-slate-800 p-4 rounded-xl mb-4 border border-slate-700">
        <div class="flex items-center justify-between mb-2 text-xs font-bold text-teal-400">
            <span>ç‡Ÿæ¥­ç¨… (5%)</span>
            <input type="checkbox" id="tax_toggle" class="w-6 h-6" onchange="calculateFinal()">
        </div>
        <input type="number" id="in_discount" class="mb-0" placeholder="æŠ˜æ‰£é‡‘é¡" oninput="calculateFinal()">
    </div>
    <button onclick="history.back()" class="w-full bg-gray-600 hover:bg-gray-500 py-3 rounded-xl font-bold text-sm mb-3 border border-gray-500 transition-colors">
        <i class="fas fa-arrow-left mr-2"></i>è¿”å›ä¸Šä¸€é 
    </button>
    <div class="grid grid-cols-2 gap-3">
        <button id="saveBtn" onclick="saveToSupabase()" class="bg-teal-700 py-4 rounded-xl font-bold text-sm border border-teal-600">å„²å­˜å ±åƒ¹</button>
        <button onclick="window.print()" class="bg-teal-600 py-4 rounded-xl font-bold text-sm shadow-lg">åˆ—å° PDF</button>
    </div>
</div>

<div class="main-content">
    <div class="a4-preview">
        <div class="flex justify-between items-end border-b-4 border-black pb-4 mb-6">
            <div>
                <h1 class="text-3xl font-black italic tracking-tighter">éŒ¦å¾·é˜²æ°´å·¥ç¨‹ å ±åƒ¹å–®</h1>
                <p class="text-[10px] font-bold mt-1 uppercase text-gray-400">Jinde Waterproofing Engineering</p>
            </div>
            <div class="text-right">
                <img id="logo_img" src="" class="max-h-16 mb-2 ml-auto" style="display:none;">
                <div class="text-[11px] font-bold">No: <span id="out_id" class="font-mono bg-yellow-50 px-1"></span><br>Date: <span id="out_date"></span></div>
            </div>
        </div>
        <div class="grid grid-cols-2 gap-8 mb-6">
            <div class="border-l-4 border-black pl-4">
                <p class="text-[10px] font-black text-gray-400">Customer å®¢æˆ¶</p>
                <p id="out_name" class="font-black text-xl">æœªå¡«å¯«</p>
            </div>
            <div class="border-l-4 border-gray-300 pl-4">
                <p class="text-[10px] font-black text-gray-400">Site æ–½å·¥åœ°å€</p>
                <p id="out_addr" class="text-sm font-bold">æœªå¡«å¯«åœ°å€</p>
            </div>
        </div>
        <div class="flex-grow">
            <table class="w-full mb-6">
                <thead>
                    <tr class="border-y-2 border-black text-[12px] font-black bg-gray-50 italic">
                        <th class="py-3 text-left pl-3">é …ç›®èªªæ˜ Description</th>
                        <th class="py-3 text-center w-20">æ•¸é‡</th>
                        <th class="py-3 text-center w-16">å–®ä½</th>
                        <th class="py-3 text-right w-24">å–®åƒ¹</th>
                        <th class="py-3 text-right pr-3 w-32">é‡‘é¡</th>
                    </tr>
                </thead>
                <tbody id="out_tbody" class="text-sm font-bold divide-y divide-gray-100"></tbody>
            </table>
            <div class="flex justify-end mb-6">
                <div class="w-64 space-y-1 text-sm font-bold">
                    <div class="flex justify-between px-2 text-xs"><span>å°è¨ˆ Subtotal</span><span id="res_sub">0</span></div>
                    <div id="tax_row" class="flex justify-between px-2 text-gray-400 hidden"><span>ç¨…é¡ (5%)</span><span id="res_tax">0</span></div>
                    <div id="disc_row" class="flex justify-between px-2 text-red-500 hidden"><span>æŠ˜æ‰£ Discount</span><span id="res_disc">0</span></div>
                    <div class="flex justify-between bg-black text-white p-3 rounded font-black italic">
                        <span>TOTAL</span><span>NT$ <span id="sum_final">0</span></span>
                    </div>
                </div>
            </div>
            <div>
                <span class="info-label">METHOD å·¥æ³•èªªæ˜</span>
                <div id="out_method" contenteditable="true" class="editable-area">é»æ“Šå·¦å´å¿«æ·æŒ‰éˆ•æˆ–åœ¨æ­¤è¼¸å…¥å·¥æ³•...</div>
            </div>
            <div>
                <span class="info-label">PHOTOS æ–½å·¥ç¾å ´åœ–</span>
                <div id="photo_grid" class="photo-grid"></div>
            </div>
            <div class="mt-4">
                <span class="info-label">REMARKS å‚™è¨»èˆ‡æ¢æ¬¾</span>
                <div id="out_terms" contenteditable="true" class="editable-area">1. æœ¬å ±åƒ¹æœ‰æ•ˆæœŸç‚º 7 å¤©ã€‚2. å®Œå·¥å¾Œæä¾› 5 å¹´ä¿å›ºï¼ˆé™æœ¬å…¬å¸æ–½å·¥ç¯„åœï¼‰ã€‚3. **ä¿å›ºå…è²¬**ï¼šè‹¥å› åœ°éœ‡å°è‡´çµæ§‹ä½ç§»è£‚ç¸«ã€äººç‚ºç ´å£æˆ–ç¬¬ä¸‰æ–¹æ–½å·¥æå‚·ï¼Œä¸åœ¨æ­¤é™ã€‚4. **æ–½å·¥ç’°å¢ƒ**ï¼šé˜²æ°´æ–½å·¥é ˆç¬¦åˆä¹¾ç‡¥æ¨™æº–ï¼Œå¦‚é‡é›¨å¤©å·¥æœŸå°‡è‡ªå‹•é †å»¶ã€‚5. **ä»˜æ¬¾æº–å‰‡**ï¼šè«‹æ¬¾è‹¥é€¾æœŸé”ä¸ƒæ—¥ï¼Œæœ¬å…¬å¸æœ‰æ¬Šæš«åœæ–½å·¥ï¼Œä¸¦ç”±æ¥­ä¸»æ‰¿æ“”æå¤±ã€‚</div>
            </div>
        </div>
        <div class="sig-container">
            <div class="sig-box"><img id="seal_img" src="">Authorized Signature (éŒ¦å¾·é˜²æ°´)</div>
            <div class="sig-box">Customer Signature (å®¢æˆ¶ç°½ç« )</div>
        </div>
    </div>
</div>
<script>
    const S_URL = 'https://wdpxgichzvfebhlukbrl.supabase.co';
    const S_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndkcHhnaWNoenZmZWJobHVrYnJsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkwMjExMzQsImV4cCI6MjA4NDU5NzEzNH0.--85I0A-7WKt0P-ex1Zdnb8UVspuMNshzQtNaLedKq0';
    const _supabase = supabase.createClient(S_URL, S_KEY);
    window.onload = updateOrderInfo;
    function updateOrderInfo() {
        document.getElementById('out_date').innerText = new Date().toLocaleDateString();
        document.getElementById('out_id').innerText = 'JD' + Math.floor(Date.now()/1000).toString().slice(-6);
    }
    function addRow(name="") {
        const tbody = document.getElementById('out_tbody');
        const tr = document.createElement('tr');
        tr.innerHTML = `<td class="py-4 pl-3"><input type="text" value="${name}" class="preview-input"></td><td class="py-4 px-2 text-center"><input type="number" value="1" class="qty preview-input text-center" oninput="calculateFinal()"></td><td class="py-4 px-2 text-center"><input type="text" value="å¼" class="preview-input text-center"></td><td class="py-4 px-2 text-right"><input type="number" value="0" class="price preview-input text-right" oninput="calculateFinal()"></td><td class="py-4 pr-3 text-right font-black subtotal">0</td><td class="no-print text-center w-8"><button onclick="this.parentElement.parentElement.remove();calculateFinal()" class="text-red-400">Ã—</button></td>`;
        tbody.appendChild(tr);
        calculateFinal();
    }
    function addPU() {
        addRow('å±‹é ‚æ²¹æ€§PUä¸‰å±¤é˜²æ°´å·¥ç¨‹(å«æ¸…é‹)');
        document.getElementById('out_method').innerText = `ã€å±‹é ‚åœ°é¢æ²¹æ€§PUä¸‰å±¤å·¥æ³•ã€‘\n1. ç´ åœ°æ•´ç†ï¼šé«˜å£“æ¸…æ´—ã€èˆŠå±¤å‰”é™¤ã€åƒåœ¾æ¸…é‹ã€‚\n2. ç¬¬ä¸€å±¤ï¼šæ»²é€å‹æ²¹æ€§åº•æ¼†æ–½ä½œã€‚\n3. ç¬¬äºŒå±¤ï¼šæ²¹æ€§PUä¸­å¡—ææ–½ä½œï¼ˆå»ºæ§‹ä¸»é˜²æ°´å±¤ï¼‰ã€‚\n4. ç¬¬ä¸‰å±¤ï¼šæŠ—UVè€å€™é¢æ¼†æ–½ä½œï¼ˆä¿è­·é˜²æ°´çµæ§‹ï¼‰ã€‚`;
    }
    function addWaterWall() {
        addRow('ç‰†é¢æ°´æ€§é˜²æ°´æ¼†äº”å±¤å·¥ç¨‹(å«æ¸…é‹)');
        document.getElementById('out_method').innerText = `ã€ç‰†é¢æ°´æ€§é˜²æ°´æ¼†äº”å±¤å·¥æ³•ã€‘\n1. ç´ åœ°æ•´ç†ï¼šé«˜å£“æ¸…æ´—ã€è£‚ç¸«è£œå¼·ã€åƒåœ¾æ¸…é‹ã€‚\n2. ç¬¬ä¸€å±¤ï¼šæ»²é€åº•æ¼†ï¼ˆå°é–‰æ°´æ³¥æ¯›ç´°å­”ï¼‰ã€‚\n3. ç¬¬äºŒã€ä¸‰å±¤ï¼šé«˜å½ˆæ€§ä¸­å¡—äºŒæ¬¡æ–½ä½œï¼ˆæ¡äº¤ç¹”å¡—ä½ˆææ˜‡æœ‰æ•ˆè†œåšï¼Œå¼·åŒ–æŠ—æ‹‰å‰ªæ‡‰åŠ›ï¼‰ã€‚\n4. ç¬¬å››ã€äº”å±¤ï¼šæŠ—UVè€å€™é¢æ¼†ï¼ˆæŠ—é¹¼é˜²è¤ªè‰²ï¼Œææ˜‡è€å€™å¹´é™ï¼‰ã€‚`;
    }
    function syncData() {
        document.getElementById('out_name').innerText = document.getElementById('in_name').value || "æœªå¡«å¯«";
        document.getElementById('out_addr').innerText = document.getElementById('in_addr').value || "æœªå¡«å¯«æ–½å·¥åœ°å€";
    }
    function calculateFinal() {
        let subtotal = 0;
        document.querySelectorAll('#out_tbody tr').forEach(row => {
            const q = parseFloat(row.querySelector('.qty').value) || 0;
            const p = parseFloat(row.querySelector('.price').value) || 0;
            const sub = q * p;
            row.querySelector('.subtotal').innerText = Math.round(sub).toLocaleString();
            subtotal += sub;
        });
        const discount = parseFloat(document.getElementById('in_discount').value) || 0;
        let tax = document.getElementById('tax_toggle').checked ? Math.round((subtotal - discount) * 0.05) : 0;
        let final = subtotal - discount + tax;
        document.getElementById('res_sub').innerText = subtotal.toLocaleString();
        document.getElementById('res_tax').innerText = tax.toLocaleString();
        document.getElementById('res_disc').innerText = '-' + discount.toLocaleString();
        document.getElementById('tax_row').classList.toggle('hidden', tax === 0);
        document.getElementById('disc_row').classList.toggle('hidden', discount === 0);
        document.getElementById('sum_final').innerText = final.toLocaleString();
    }
    function loadImage(e, id) {
        const file = e.target.files[0];
        if (file) {
            const url = URL.createObjectURL(file);
            const el = document.getElementById(id);
            el.src = url; el.style.display = 'block';
        }
    }
    function loadMultipleImages(e) {
        const files = e.target.files;
        const grid = document.getElementById('photo_grid');
        Array.from(files).forEach(file => {
            const container = document.createElement('div');
            container.className = 'photo-item';
            const img = document.createElement('img');
            img.src = URL.createObjectURL(file);
            const btn = document.createElement('button');
            btn.className = 'del-btn no-print';
            btn.innerHTML = 'Ã—';
            btn.onclick = () => container.remove();
            container.appendChild(img);
            container.appendChild(btn);
            grid.appendChild(container);
        });
    }
    async function saveToSupabase() {
        const btn = document.getElementById('saveBtn');
        const quoteId = document.getElementById('out_id').innerText;
        btn.disabled = true; btn.innerText = "å„²å­˜ä¸­...";
        const items = [];
        document.querySelectorAll('#out_tbody tr').forEach(row => {
            items.push({
                desc: row.cells[0].querySelector('input').value,
                qty: row.querySelector('.qty').value,
                price: row.querySelector('.price').value
            });
        });
        const { data, error } = await _supabase.from('quotations').insert([{
            quote_id: quoteId,
            client: document.getElementById('in_name').value || "æœªå¡«å¯«",
            address: document.getElementById('in_addr').value || "æœªå¡«å¯«",
            total: document.getElementById('sum_final').innerText.replace(/,/g, ''),
            items: JSON.stringify(items),
            method: document.getElementById('out_method').innerText,
            terms: document.getElementById('out_terms').innerText
        }]);
        if (error) {
            alert("å„²å­˜å¤±æ•—: " + error.message);
        } else {
            alert("ã€å„²å­˜æˆåŠŸã€‘å–®è™Ÿ: " + quoteId);
            updateOrderInfo();
        }
        btn.disabled = false; btn.innerText = "å„²å­˜å ±åƒ¹";
    }
</script>
</body>
</html>
