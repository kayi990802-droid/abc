<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>JINDE | 數位保固生產系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@900&family=Noto+Sans+TC:wght@400;700&display=swap');
        :root { --primary: #0d9488; }
        body { background-color: #0f172a; font-family: 'Noto Sans TC', sans-serif; }
        .admin-panel { background: #1a222d; color: white; }
        .glass-input { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: white; border-radius: 8px; padding: 12px; width: 100%; outline: none; }
        .glass-input:focus { border-color: var(--primary); }
        .a4-page { 
            width: 210mm; height: 297mm; padding: 20mm; background: white; color: black; 
            position: relative; box-shadow: 0 0 20px rgba(0,0,0,0.5); transform-origin: top center;
        }
        @media (max-width: 1024px) { .a4-page { transform: scale(0.4); margin-bottom: -180mm; } }
        @media print { .no-print { display: none !important; } .a4-page { transform: scale(1); box-shadow: none; margin: 0; } }
        .underline-input { border-bottom: 1.5pt solid black; padding: 0 10px; font-weight: 900; }
    </style>
</head>
<body class="flex flex-col lg:flex-row min-h-screen">

    <div class="no-print admin-panel w-full lg:w-96 p-6 overflow-y-auto">
        <h2 class="text-2xl font-black mb-1">JINDE<span class="text-teal-500">.</span></h2>
        <p class="text-xs text-slate-500 mb-6 tracking-widest text-uppercase">保固書生產系統</p>
        
        <div class="space-y-4">
            <div>
                <label class="text-xs text-slate-400">客戶姓名</label>
                <input type="text" id="in_client" class="glass-input" oninput="sync()" placeholder="例：王小明">
            </div>
            <div>
                <label class="text-xs text-slate-400">案場地址</label>
                <textarea id="in_p_name" class="glass-input" oninput="sync()" placeholder="詳細施工地點"></textarea>
            </div>
            <div class="grid grid-cols-2 gap-2">
                <div>
                    <label class="text-xs text-slate-400">完工日期</label>
                    <input type="date" id="in_date" class="glass-input text-sm" oninput="sync()">
                </div>
                <div>
                    <label class="text-xs text-slate-400">保固年限</label>
                    <input type="number" id="in_years" value="3" class="glass-input" oninput="sync()">
                </div>
            </div>
            <div>
                <label class="text-xs text-slate-400">施工工法</label>
                <select id="in_work_type" class="glass-input" onchange="sync()">
                    <option value="高壓灌注止漏工法">高壓灌注止漏工法</option>
                    <option value="複合式防水工程">複合式防水工程</option>
                    <option value="外牆滲漏修繕">外牆滲漏修繕</option>
                    <option value="屋頂隔熱防水">屋頂隔熱防水</option>
                </select>
            </div>
            <button id="saveBtn" onclick="saveAndPrint()" class="w-full bg-teal-600 hover:bg-teal-500 py-4 rounded-xl font-bold mt-4 transition-all active:scale-95">
                <i class="fas fa-print mr-2"></i> 儲存並列印 PDF
            </button>
        </div>
    </div>

    <div class="preview-area flex-grow flex justify-center p-4 lg:p-10 overflow-y-auto">
        <div class="a4-page font-serif" id="print-content">
            <div class="flex justify-between items-end border-b-2 border-black pb-2 mb-10">
                <div class="text-xl font-bold tracking-[0.3em]">專 業 · 態 度 · 細 心 · 責 任</div>
                <div class="text-sm italic text-gray-400">Jinde Engineering Hub</div>
            </div>

            <h1 class="text-center text-5xl font-black mb-16 tracking-[0.5em] italic">服務保固書</h1>
            
            <div class="text-xl leading-[2.2] text-justify mb-10">
                茲承攬 <span id="out_client" class="underline-input text-2xl italic">未填寫</span> 之 <span id="out_p_name" class="underline-input italic text-2xl">未填寫</span> <br>
                <span id="out_work_type" class="font-bold underline-input">高壓灌注止漏工法</span>。本公司承諾對施工品質負完全責任，若於保固期間內發生施工瑕疵導致之滲漏，本公司將負責無償修繕完成。
            </div>

            <table class="w-full border-collapse border-2 border-black">
                <tr>
                    <td class="border border-black p-4 bg-gray-50 font-bold w-32 text-center">保固期限</td>
                    <td class="border border-black p-4 font-bold" colspan="3">
                        自民國 <span class="d_y"></span> 年 <span class="d_m"></span> 月 <span class="d_d"></span> 日起，共計 <span id="out_years">3</span> 年。
                    </td>
                </tr>
                <tr>
                    <td class="border border-black p-4 bg-gray-50 font-bold text-center">承攬廠商</td>
                    <td class="border border-black p-4 font-black text-xl">錦德工程行</td>
                    <td class="border border-black p-4 bg-gray-50 font-bold text-center w-32">統一編號</td>
                    <td class="border border-black p-4 font-mono">80081612</td>
                </tr>
                <tr>
                    <td class="border border-black p-4 bg-gray-50 font-bold text-center">負責人</td>
                    <td class="border border-black p-4 text-lg">王震昱</td>
                    <td class="border border-black p-4 bg-gray-50 font-bold text-center">聯絡電話</td>
                    <td class="border border-black p-4 font-mono font-bold">0963-696-032</td>
                </tr>
                <tr>
                    <td class="border border-black p-4 bg-gray-50 font-bold text-center">通訊地址</td>
                    <td class="border border-black p-4" colspan="3">臺中市東區建德街 346 巷 7 號</td>
                </tr>
            </table>

            <div class="absolute bottom-24 left-20 flex items-center gap-6">
                <div class="border-2 border-black p-1 bg-white">
                    <img id="qr_img" src="" class="w-24 h-24">
                </div>
                <div class="text-sm">
                    <span class="font-black text-lg">數位保固驗證中心</span><br>
                    核發編號：<span id="doc_id" class="font-mono font-bold text-teal-700"></span><br>
                    <span class="text-gray-400 text-xs uppercase">Authentic Verified System</span>
                </div>
            </div>

            <div class="absolute bottom-24 right-20 text-right font-black text-2xl">
                中 華 民 國 <span class="d_y"></span> 年 <span class="d_m"></span> 月 <span class="d_d"></span> 日
            </div>
        </div>
    </div>

    <script>
        const S_URL = 'https://wdpxgichzvfebhlukbrl.supabase.co';
        const S_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndkcHhnaWNoenZmZWJobHVrYnJsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkwMjExMzQsImV4cCI6MjA4NDU5NzEzNH0.--85I0A-7WKt0P-ex1Zdnb8UVspuMNshzQtNaLedKq0';
        const _supabase = supabase.createClient(S_URL, S_KEY);

        window.onload = () => {
            document.getElementById('in_date').value = new Date().toISOString().split('T')[0];
            sync();
        };

        function sync() {
            const client = document.getElementById('in_client').value || "未填寫";
            const project = document.getElementById('in_p_name').value || "未填寫";
            const years = document.getElementById('in_years').value || 3;
            
            document.getElementById('out_client').innerText = client;
            document.getElementById('out_p_name').innerText = project;
            document.getElementById('out_years').innerText = years;
            document.getElementById('out_work_type').innerText = document.getElementById('in_work_type').value;

            if(!window.docId) window.docId = `JD-${Date.now().toString().slice(-6)}`;
            document.getElementById('doc_id').innerText = window.docId;

            // 重要：QR Code 連結到你的 verify.html (部署後的網址)
            const verifyUrl = `https://your-site.com/verify.html?id=${window.docId}`;
            document.getElementById('qr_img').src = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(verifyUrl)}`;

            const d = new Date(document.getElementById('in_date').value);
            document.querySelectorAll('.d_y').forEach(el => el.innerText = d.getFullYear() - 1911);
            document.querySelectorAll('.d_m').forEach(el => el.innerText = d.getMonth() + 1);
            document.querySelectorAll('.d_d').forEach(el => el.innerText = d.getDate());
        }

        async function saveAndPrint() {
            const client = document.getElementById('in_client').value;
            if(!client) return alert("請輸入客戶姓名");
            
            const btn = document.getElementById('saveBtn');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 上傳資料中...';
            
            const { error } = await _supabase.from('warranties').insert([{
                doc_id: window.docId,
                client_name: client,
                project_name: document.getElementById('in_p_name').value,
                warranty_years: parseInt(document.getElementById('in_years').value),
                created_at: new Date(document.getElementById('in_date').value).toISOString()
            }]);

            if (error) alert("上傳失敗: " + error.message);
            else window.print();
            
            btn.innerHTML = '<i class="fas fa-print mr-2"></i> 儲存並列印 PDF';
        }
    </script>
</body>
</html>
