<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JINDE | 保固書生產系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700;900&family=Noto+Sans+TC:wght@400;700&display=swap');
        
        body { background-color: #0f172a; margin: 0; padding: 0; display: flex; height: 100vh; overflow: hidden; font-family: 'Noto Sans TC', sans-serif; }
        @page { size: A4; margin: 0; }
        
        /* 控制面板 */
        .admin-panel { width: 380px; height: 100vh; background: #1e293b; padding: 30px; z-index: 1000; border-right: 1px solid rgba(255,255,255,0.1); overflow-y: auto; color: white; flex-shrink: 0; }
        
        /* 預覽區 */
        .preview-area { flex-grow: 1; height: 100vh; overflow-y: auto; padding: 40px; display: flex; justify-content: center; background: #0f172a; }
        
        /* A4 紙張設定 */
        .a4-page { width: 210mm; height: 297mm; padding: 25mm 22mm; background: white; font-family: 'Noto Serif TC', serif; color: #1a1a1a; position: relative; box-sizing: border-box; box-shadow: 0 0 50px rgba(0,0,0,0.5); flex-shrink: 0; }
        
        .page-header { border-bottom: 2px solid #000; padding-bottom: 8px; display: flex; justify-content: space-between; align-items: flex-end; }
        .main-title { font-size: 38pt; font-weight: 900; text-align: center; margin: 35pt 0; letter-spacing: 0.5em; }
        .content-body { font-size: 14.5pt; line-height: 2.2; text-align: justify; margin-bottom: 25pt; }
        .underline-input { font-weight: 700; border-bottom: 2px solid #000; padding: 0 10px; display: inline-block; min-width: 150px; text-align: center; }
        
        table { width: 100%; border-collapse: collapse; }
        td { border: 1.5pt solid #000; padding: 12pt; font-size: 13pt; }
        .bg-gray { background-color: #f5f5f5; font-weight: 700; width: 125px; text-align: center; }
        
        #logo_preview { position: absolute; top: 45mm; right: 22mm; max-width: 55mm; max-height: 25mm; display: none; }
        #seal_preview { position: absolute; bottom: 105px; right: 145px; width: 145px; display: none; transform: rotate(-8deg); z-index: 10; opacity: 0.9; }

        @media print { 
            body { background: none; } 
            .no-print { display: none !important; } 
            .preview-area { padding: 0; display: block; overflow: visible; } 
            .a4-page { margin: 0 auto; box-shadow: none; border: none; } 
        }
    </style>
</head>
<body>

    <div class="no-print admin-panel">
        <a href="index.html" class="flex items-center gap-2 text-slate-400 mb-8 hover:text-teal-400 transition-all">
            <i class="fas fa-arrow-left"></i> 返回中台總覽
        </a>
        <h2 class="text-2xl font-black mb-6 text-teal-400">核發保固證書</h2>
        
        <div class="space-y-5">
            <div class="grid grid-cols-2 gap-2">
                <div><label class="text-[10px] text-slate-400 font-bold uppercase">1. 公司 Logo</label>
                <input type="file" class="w-full text-[10px] mt-1" onchange="loadFile(event, 'logo_preview')"></div>
                <div><label class="text-[10px] text-rose-400 font-bold uppercase">2. 數位印章</label>
                <input type="file" class="w-full text-[10px] mt-1" onchange="loadFile(event, 'seal_preview')"></div>
            </div>

            <div><label class="text-xs text-slate-400 font-bold">客戶姓名</label>
            <input type="text" id="in_client" placeholder="例：王小明 先生" class="w-full bg-slate-800 rounded-xl p-3 text-sm mt-1 outline-none focus:ring-2 focus:ring-teal-500" oninput="sync()"></div>
            
            <div><label class="text-xs text-slate-400 font-bold">工程案場與地址</label>
            <textarea id="in_p_name" rows="2" placeholder="例：台中市南區復興路二段..." class="w-full bg-slate-800 rounded-xl p-3 text-sm mt-1 outline-none focus:ring-2 focus:ring-teal-500" oninput="sync()"></textarea></div>
            
            <div class="grid grid-cols-2 gap-4">
                <div><label class="text-xs text-slate-400 font-bold">保固期限 (年)</label>
                <input type="number" id="in_years" value="3" class="w-full bg-slate-800 rounded-xl p-3 text-sm mt-1 outline-none" oninput="sync()"></div>
                <div><label class="text-xs text-slate-400 font-bold">完工金額</label>
                <input type="number" id="in_amount" placeholder="NT$" class="w-full bg-slate-800 rounded-xl p-3 text-sm mt-1 outline-none" oninput="sync()"></div>
            </div>

            <div><label class="text-xs text-slate-400 font-bold">施工工法</label>
            <select id="in_work_type" class="w-full bg-slate-800 rounded-xl p-3 text-sm mt-1 outline-none" onchange="sync()">
                <option value="高壓灌注止漏工法">高壓灌注止漏工法</option>
                <option value="複合式防水工程">複合式防水工程</option>
                <option value="外牆滲漏修繕">外牆滲漏修繕</option>
                <option value="屋頂隔熱防水">屋頂隔熱防水</option>
            </select></div>

            <div class="pt-4">
                <button id="saveBtn" onclick="saveAndPrint()" class="w-full bg-teal-500 hover:bg-teal-400 text-white py-4 rounded-2xl font-black text-lg shadow-lg transition-all active:scale-95">
                    <i class="fas fa-save mr-2"></i> 儲存並列印
                </button>
                <p class="text-[10px] text-center text-slate-500 mt-3 italic">點擊將同步至 Supabase 雲端資料庫</p>
            </div>
        </div>
    </div>

    <div class="preview-area">
        <div class="a4-page" id="printSection">
            <div class="page-header">
                <div class="text-[13pt] font-semibold tracking-[0.6em]">專 業 · 態 度 · 細 心 · 責 任</div>
                <div class="text-sm italic text-gray-400 font-sans text-right uppercase">Jinde Engineering</div>
            </div>
            <div class="border-b border-black mt-1 mb-12"></div>
            
            <img id="logo_preview" src="">
            <h1 class="main-title">服務保固書</h1>

            <div class="content-body">
                茲承攬 <span id="out_client" class="underline-input">未填寫</span> 之 <span id="out_p_name" class="underline-input">未填寫</span> <span id="out_work_type" class="font-bold">高壓灌注止漏工法</span>。本公司承諾對施工品質負完全責任，若於保固期間內發生施工瑕疵導致之滲漏，本公司將負責無償修繕完成。
            </div>

            <table>
                <tr><td class="bg-gray">保固期限</td><td colspan="3" class="font-bold italic">自民國 <span class="d_y"></span> 年 <span class="d_m"></span> 月 <span class="d_d"></span> 日起，共計 <span id="out_years">3</span> 年。</td></tr>
                <tr><td class="bg-gray">承攬廠商</td><td class="text-xl font-black">錦德工程行</td><td class="bg-gray">統一編號</td><td class="font-bold font-mono">80081612</td></tr>
                <tr><td class="bg-gray">負責人</td><td class="text-lg">王震昱</td><td class="bg-gray">聯絡電話</td><td class="font-bold font-mono">0963-696-032</td></tr>
                <tr><td class="bg-gray">通訊地址</td><td colspan="3">401 臺中市東區建德街 346 巷 7 號</td></tr>
            </table>

            <div class="absolute bottom-[35mm] left-[22mm] flex items-center gap-4">
                <div class="border border-black p-1 bg-white"><img id="qr_img" src="" class="w-20 h-20"></div>
                <div class="text-[9pt] leading-relaxed">數位保固驗證系統<br>核發編號：<span id="doc_id" class="font-mono font-bold text-blue-800"></span><br><span class="text-gray-400 tracking-tighter uppercase">Authentic Guarantee</span></div>
            </div>

            <img id="seal_preview" src="">

            <div class="absolute bottom-[35mm] right-[22mm] text-right">
                <p class="font-black text-2xl tracking-tight">中 華 民 國 <span class="d_y"></span> 年 <span class="d_m"></span> 月 <span class="d_d"></span> 日</p>
            </div>
        </div>
    </div>

    <script>
        // Supabase 設定
        const S_URL = 'https://wdpxgichzvfebhlukbrl.supabase.co';
        const S_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndkcHhnaWNoenZmZWJobHVrYnJsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkwMjExMzQsImV4cCI6MjA4NDU5NzEzNH0.--85I0A-7WKt0P-ex1Zdnb8UVspuMNshzQtNaLedKq0';
        const _supabase = supabase.createClient(S_URL, S_KEY);

        function loadFile(event, targetId) {
            const output = document.getElementById(targetId);
            if(event.target.files[0]) {
                output.src = URL.createObjectURL(event.target.files[0]);
                output.style.display = 'block';
            }
        }

        function sync() {
            const client = document.getElementById('in_client').value || "未填寫";
            const project = document.getElementById('in_p_name').value || "未填寫";
            const years = document.getElementById('in_years').value;
            const workType = document.getElementById('in_work_type').value;

            document.getElementById('out_client').innerText = client;
            document.getElementById('out_p_name').innerText = project;
            document.getElementById('out_years').innerText = years;
            document.getElementById('out_work_type').innerText = workType;

            // 生成唯一編號
            if(!window.docId) {
                const datePart = new Date().toISOString().slice(0, 10).replace(/-/g, '');
                window.docId = `JD-${datePart}-${Math.random().toString(36).substr(2, 4).toUpperCase()}`;
            }
            document.getElementById('doc_id').innerText = window.docId;

            // QR Code 連接
            const verifyUrl = `https://kayi990802-droid.github.io/abc/verify.html?id=${window.docId}`;
            document.getElementById('qr_img').src = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(verifyUrl)}`;

            // 日期計算 (民國)
            const now = new Date();
            const y = now.getFullYear() - 1911;
            const m = now.getMonth() + 1;
            const d = now.getDate();
            document.querySelectorAll('.d_y').forEach(el => el.innerText = y);
            document.querySelectorAll('.d_m').forEach(el => el.innerText = m);
            document.querySelectorAll('.d_d').forEach(el => el.innerText = d);
        }

        async function saveAndPrint() {
            const btn = document.getElementById('saveBtn');
            const clientName = document.getElementById('in_client').value;
            const projectName = document.getElementById('in_p_name').value;
            const amount = document.getElementById('in_amount').value || 0;

            if(!clientName || !projectName) return alert("請完整填寫客戶姓名與案場名稱！");

            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> 正在上傳雲端...';
            btn.disabled = true;

            try {
                // 將資料存入 Supabase 的 warranties 資料表
                const { error } = await _supabase.from('warranties').insert([{ 
                    warranty_no: window.docId,
                    client_name: clientName,
                    project_name: projectName,
                    work_type: document.getElementById('in_work_type').value,
                    warranty_years: parseInt(document.getElementById('in_years').value),
                    amount: parseInt(amount),
                    status: '有效'
                }]);

                if (error) throw error;

                btn.innerHTML = '<i class="fas fa-print mr-2"></i> 存檔完成，列印中...';
                
                setTimeout(() => { 
                    window.print(); 
                    btn.innerHTML = '<i class="fas fa-save mr-2"></i> 儲存並列印'; 
                    btn.disabled = false; 
                }, 1000);

            } catch (err) {
                console.error(err);
                alert("存檔失敗：" + err.message);
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-save mr-2"></i> 儲存並列印';
            }
        }

        window.onload = sync;
    </script>
</body>
</html>
