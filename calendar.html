<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>JINDE | 現場行程</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        body { background-color: #f1f5f9; font-family: 'Noto Sans TC', sans-serif; -webkit-tap-highlight-color: transparent; color: #1e293b; }
        
        /* 輕量化月曆格 */
        .calendar-cell { 
            aspect-ratio: 1/1; 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-size: 14px; font-weight: 500; border-radius: 14px; transition: 0.3s; position: relative;
        }
        .calendar-cell.active { 
            background: #0d9488 !important; color: white !important; 
            box-shadow: 0 10px 15px -3px rgba(13, 148, 136, 0.4); transform: scale(0.9);
        }
        .calendar-cell.today { color: #0d9488; font-weight: 900; background: #ccfbf1; }

        /* 行程指示點 */
        .dot-container { position: absolute; bottom: 6px; display: flex; gap: 2px; }
        .dot { width: 4px; height: 4px; border-radius: 50%; }
        .dot-work { background: #0ea5e9; }
        .dot-other { background: #94a3b8; }

        /* 行程卡片質感 */
        .event-card {
            background: white; border-radius: 24px; padding: 20px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); border: 1px solid rgba(255,255,255,0.8);
            transition: 0.3s;
        }
        .event-card:active { transform: scale(0.98); background: #f8fafc; }

        /* 磨砂玻璃頂部 */
        .glass-header {
            background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px); border-bottom: 1px solid rgba(255,255,255,0.3);
        }

        /* 隱藏滾動條 */
        ::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="pb-32">

    <header class="glass-header sticky top-0 z-50 px-6 py-4 flex justify-between items-center">
        <div>
            <p class="text-[10px] font-black text-teal-600 uppercase tracking-widest">Schedule</p>
            <h1 class="text-xl font-black" id="monthDisplay">2026年 1月</h1>
        </div>
        <div class="flex items-center gap-2 bg-slate-100 p-1 rounded-xl">
            <button onclick="changeMonth(-1)" class="w-8 h-8 flex items-center justify-center text-slate-500 hover:text-slate-800"><i class="fas fa-chevron-left text-xs"></i></button>
            <button onclick="changeMonth(1)" class="w-8 h-8 flex items-center justify-center text-slate-500 hover:text-slate-800"><i class="fas fa-chevron-right text-xs"></i></button>
        </div>
    </header>

    <div class="px-4 mt-4">
        <div class="bg-white rounded-[32px] p-4 shadow-xl shadow-slate-200/50">
            <div class="grid grid-cols-7 text-center mb-2">
                <div class="text-[10px] font-bold text-slate-300 py-2">日</div>
                <div class="text-[10px] font-bold text-slate-300 py-2">一</div>
                <div class="text-[10px] font-bold text-slate-300 py-2">二</div>
                <div class="text-[10px] font-bold text-slate-300 py-2">三</div>
                <div class="text-[10px] font-bold text-slate-300 py-2">四</div>
                <div class="text-[10px] font-bold text-slate-300 py-2">五</div>
                <div class="text-[10px] font-bold text-slate-300 py-2">六</div>
            </div>
            <div id="calendarBody" class="grid grid-cols-7 gap-1">
                </div>
        </div>
    </div>

    <div class="px-6 mt-8">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-lg font-black" id="selectedDateLabel">今日行程</h2>
            <div class="px-3 py-1 bg-slate-200 rounded-full text-[10px] font-bold text-slate-500" id="fullDateLabel">2026-01-27</div>
        </div>
        
        <div id="dayDetailList" class="space-y-4">
            </div>
    </div>

    <div class="fixed bottom-8 left-0 right-0 flex justify-center px-8 gap-4 z-[100]">
        <button onclick="location.href='index.html'" class="w-14 h-14 bg-white rounded-2xl shadow-xl flex items-center justify-center text-slate-400">
            <i class="fas fa-home text-xl"></i>
        </button>
        <button onclick="openAddModal()" class="flex-grow h-14 bg-slate-900 rounded-2xl shadow-xl shadow-slate-300 text-white font-bold flex items-center justify-center gap-3">
            <i class="fas fa-plus"></i> 新增工程行程
        </button>
    </div>

    <div id="addModal" class="fixed inset-0 bg-white z-[200] hidden flex-col transition-all duration-300 translate-y-full">
        <div class="p-6 flex justify-between items-center border-b">
            <button onclick="closeAddModal()" class="w-10 h-10 bg-slate-50 rounded-full flex items-center justify-center"><i class="fas fa-times"></i></button>
            <h3 class="font-black text-lg">安排行程</h3>
            <button form="eventForm" type="submit" class="text-teal-600 font-black">儲存</button>
        </div>
        <form id="eventForm" onsubmit="saveEvent(event)" class="p-8 space-y-8 overflow-y-auto">
            <div class="space-y-2">
                <label class="text-xs font-black text-slate-400 uppercase tracking-widest">日期</label>
                <input type="date" id="form_date" class="w-full text-2xl font-black bg-transparent border-none outline-none focus:ring-0 p-0" required>
            </div>
            <div class="space-y-2">
                <label class="text-xs font-black text-slate-400 uppercase tracking-widest">案場名稱</label>
                <input type="text" id="form_title" placeholder="請輸入案場或工作內容" class="w-full text-xl font-bold bg-slate-50 p-4 rounded-2xl border-none outline-none" required>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div class="space-y-2">
                    <label class="text-xs font-black text-slate-400 uppercase tracking-widest">分類</label>
                    <select id="form_type" class="w-full bg-slate-50 p-4 rounded-2xl border-none outline-none font-bold">
                        <option value="work">工程案場</option>
                        <option value="other">其他備註</option>
                    </select>
                </div>
                <div class="space-y-2">
                    <label class="text-xs font-black text-slate-400 uppercase tracking-widest">指派人員</label>
                    <input type="text" id="form_staff" placeholder="人員姓名" class="w-full bg-slate-50 p-4 rounded-2xl border-none outline-none font-bold">
                </div>
            </div>
        </form>
    </div>

    <script>
        const S_URL = 'https://wdpxgichzvfebhlukbrl.supabase.co';
        const S_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndkcHhnaWNoenZmZWJobHVrYnJsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkwMjExMzQsImV4cCI6MjA4NDU5NzEzNH0.--85I0A-7WKt0P-ex1Zdnb8UVspuMNshzQtNaLedKq0';
        const _supabase = supabase.createClient(S_URL, S_KEY);

        let viewDate = new Date();
        let allEvents = [];
        let selectedDateStr = new Date().toISOString().split('T')[0];

        async function init() {
            const { data } = await _supabase.from('staff_schedules').select('*').order('created_at', { ascending: false });
            allEvents = data || [];
            renderCalendar();
            loadDayDetail(selectedDateStr);
        }

        function renderCalendar() {
            const year = viewDate.getFullYear();
            const month = viewDate.getMonth();
            document.getElementById('monthDisplay').innerText = `${year}年 ${month + 1}月`;

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const body = document.getElementById('calendarBody');
            body.innerHTML = '';

            for (let i = 0; i < firstDay; i++) body.innerHTML += '<div></div>';

            for (let d = 1; d <= daysInMonth; d++) {
                const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const dayEvents = allEvents.filter(e => e.work_date === dateStr);
                const isSelected = selectedDateStr === dateStr;
                const isToday = new Date().toISOString().split('T')[0] === dateStr;
                
                let dots = dayEvents.slice(0, 3).map(e => `<span class="dot ${e.type === 'work' ? 'dot-work' : 'dot-other'}"></span>`).join('');

                body.innerHTML += `
                    <div class="calendar-cell ${isSelected ? 'active' : (isToday ? 'today' : '')}" onclick="selectDate('${dateStr}')">
                        <span>${d}</span>
                        <div class="dot-container">${dots}</div>
                    </div>
                `;
            }
        }

        function selectDate(dateStr) {
            selectedDateStr = dateStr;
            renderCalendar();
            loadDayDetail(dateStr);
        }

        function loadDayDetail(dateStr) {
            document.getElementById('fullDateLabel').innerText = dateStr;
            const dayEvents = allEvents.filter(e => e.work_date === dateStr);
            const list = document.getElementById('dayDetailList');
            
            if(dayEvents.length === 0) {
                list.innerHTML = `<div class="py-12 text-center text-slate-300 font-medium">本日尚未安排行程</div>`;
                return;
            }

            list.innerHTML = dayEvents.map(e => `
                <div class="event-card relative group">
                    <div class="flex items-center gap-3 mb-3">
                        <div class="w-2 h-2 rounded-full ${e.type === 'work' ? 'bg-sky-500' : 'bg-slate-400'}"></div>
                        <span class="text-[10px] font-black uppercase text-slate-400 tracking-widest">${e.type === 'work' ? '現場工程' : '備註事項'}</span>
                    </div>
                    <h4 class="text-lg font-bold text-slate-800">${e.title}</h4>
                    <div class="mt-4 flex justify-between items-center">
                        <div class="flex items-center gap-2 text-slate-500 text-xs font-bold bg-slate-50 px-3 py-1.5 rounded-lg">
                            <i class="far fa-user"></i>
                            <span>${e.staff_names || '未指派'}</span>
                        </div>
                        <button onclick="deleteEvent('${e.id}')" class="w-8 h-8 rounded-full flex items-center justify-center text-slate-200 hover:text-rose-500 transition">
                            <i class="fas fa-trash-alt text-xs"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        async function saveEvent(e) {
            e.preventDefault();
            const payload = {
                work_date: document.getElementById('form_date').value,
                title: document.getElementById('form_title').value,
                type: document.getElementById('form_type').value,
                staff_names: document.getElementById('form_staff').value
            };
            const { error } = await _supabase.from('staff_schedules').insert([payload]);
            if(!error) {
                closeAddModal();
                init();
            }
        }

        async function deleteEvent(id) {
            if(!confirm('確定要移除此行程？')) return;
            await _supabase.from('staff_schedules').delete().eq('id', id);
            init();
        }

        function changeMonth(offset) { viewDate.setMonth(viewDate.getMonth() + offset); renderCalendar(); }
        
        function openAddModal() { 
            const modal = document.getElementById('addModal');
            document.getElementById('form_date').value = selectedDateStr;
            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.remove('translate-y-full'), 10);
        }
        
        function closeAddModal() { 
            const modal = document.getElementById('addModal');
            modal.classList.add('translate-y-full');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        window.onload = init;
    </script>
</body>
</html>
