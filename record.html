<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>保固查詢 | JINDE</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pocketbase/0.21.1/pocketbase.umd.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        body { background: #f8fafc; font-family: 'Noto Sans TC', sans-serif; }
        .card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 12px; border: 1px solid #e2e8f0; }
    </style>
</head>
<body class="p-4">
    <header class="mb-6 flex justify-between items-center">
        <h1 class="text-2xl font-black text-slate-800">保固紀錄中心</h1>
        <button onclick="checkAndLoad()" class="bg-teal-600 text-white px-4 py-2 rounded-lg text-sm">手動重新整理</button>
    </header>

    <div id="debug-info" class="mb-4 p-3 bg-amber-50 text-amber-700 text-xs rounded border border-amber-200 hidden"></div>

    <div id="recordList">
        <p class="text-center p-10 text-slate-400">連線中...</p>
    </div>

    <script>
        // 請確保這個網址是您目前的 ngrok 網址
        const pb = new PocketBase('https://unoppressed-nonanimate-albertina.ngrok-free.dev');

        async function checkAndLoad() {
            const list = document.getElementById('recordList');
            const debug = document.getElementById('debug-info');
            debug.classList.remove('hidden');
            debug.innerText = "正在檢查連線與權限...";

            try {
                // 1. 嘗試抓取資料
                const records = await pb.collection('WarrantyRecords').getFullList({
                    sort: '-created',
                    requestKey: null // 禁用快取，確保拿到最新資料
                });

                debug.innerText = `成功連線！找到 ${records.length} 筆資料。`;
                
                if (records.length === 0) {
                    list.innerHTML = `<div class="p-20 text-center text-slate-400">資料庫內尚無資料，請先在後台新增。</div>`;
                    return;
                }

                // 2. 渲染畫面
                list.innerHTML = records.map(item => `
                    <div class="card">
                        <div class="flex justify-between border-b pb-2 mb-2">
                            <span class="text-[10px] font-bold text-teal-600">${item.warranty_id || '無編號'}</span>
                            <span class="text-[10px] text-slate-400">${new Date(item.created).toLocaleDateString()}</span>
                        </div>
                        <div class="text-lg font-black text-slate-800">${item.client_name || '未填寫客戶'}</div>
                        <div class="text-sm text-slate-500 mt-1">${item.project_name || '未填寫案場'}</div>
                        <div class="mt-3 text-right">
                            <span class="bg-slate-100 text-slate-600 px-2 py-1 rounded text-xs font-bold">${item.years || 0} 年保固</span>
                        </div>
                    </div>
                `).join('');

            } catch (err) {
                console.error(err);
                debug.classList.replace('bg-amber-50', 'bg-rose-50');
                debug.classList.replace('text-amber-700', 'text-rose-700');
                
                // 3. 針對 204 或 403 報錯的提示
                if (err.status === 0) {
                    debug.innerText = "錯誤：網址無效或 ngrok 已過期。";
                } else if (err.status === 403 || err.status === 400) {
                    debug.innerText = "錯誤 403/400：權限不足。請去 PocketBase 後台將 API Rules 設為 TRUE。";
                } else {
                    debug.innerText = "錯誤代碼：" + err.status + " - " + err.message;
                }
                list.innerHTML = `<p class="text-center p-10 text-rose-400 font-bold">讀取失敗</p>`;
            }
        }

        window.onload = checkAndLoad;
    </script>
</body>
</html>
