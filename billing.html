<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>JINDE | éŒ¦å¾·å·¥ç¨‹è«‹æ¬¾é›²ç«¯ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #0f172a; color: #f1f5f9; margin: 0; }
        
        @media (min-width: 1024px) {
            body { display: flex; flex-direction: row; height: 100vh; overflow: hidden; }
            .admin-sidebar { width: 400px; height: 100vh; overflow-y: auto; background: #1e293b; border-right: 1px solid rgba(255,255,255,0.1); }
            .main-content { flex: 1; height: 100vh; overflow-y: auto; padding: 40px; background: #334155; }
        }

        /* A4 ç´™å¼µæœ¬é«” */
        .a4-preview {
            width: 210mm; min-height: 297mm; background: white; color: #1e293b;
            padding: 15mm 20mm; margin: 0 auto; box-shadow: 0 10px 50px rgba(0,0,0,0.5);
            display: flex; flex-direction: column; position: relative; border-radius: 2px;
        }

        /* æ‰‹æ©Ÿé©é…ç¸®æ”¾ */
        @media (max-width: 1023px) {
            .admin-sidebar { width: 100%; padding: 20px; }
            .main-content { width: 100%; padding: 10px 0; }
            .a4-preview { transform: scale(calc(100vw / 225mm)); transform-origin: top center; margin-bottom: calc(-297mm * (1 - (100vw / 225mm))); }
        }

        .sidebar-input { background: #0f172a; border: 1px solid #334155; color: white; border-radius: 12px; padding: 12px; width: 100%; font-size: 14px; outline: none; transition: all 0.2s; }
        .sidebar-input:focus { border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2); }

        .billing-input { border: none; background: transparent; width: 100%; color: inherit; font-size: inherit; font-weight: inherit; padding: 2px; }
        .billing-input:hover { background: rgba(59, 130, 246, 0.05); }
        .billing-input:focus { background: white; outline: 1px solid #3b82f6; border-radius: 4px; }

        @media print {
            .no-print { display: none !important; }
            body, .main-content { background: white; display: block; overflow: visible; }
            .a4-preview { transform: scale(1) !important; margin: 0 !important; box-shadow: none; border: none; width: 210mm; }
            .bg-slate-900 { background-color: #0f172a !important; -webkit-print-color-adjust: exact; }
            .text-white { color: #ffffff !important; -webkit-print-color-adjust: exact; }
        }
    </style>
</head>
<body>

    <aside class="admin-sidebar no-print p-6 space-y-6">
        <a href="javascript:void(0);" onclick="goHome()" class="flex items-center gap-2 text-slate-400 hover:text-white transition-colors text-sm font-bold group">
            <div class="w-8 h-8 rounded-full bg-slate-900 flex items-center justify-center group-hover:bg-blue-600 transition-all">
                <i class="fas fa-arrow-left"></i>
            </div>
            è¿”å›ä¸»é¸å–®
        </a>

        <div class="flex justify-between items-center">
            <h2 class="text-2xl font-black text-blue-400 italic uppercase">Jinde <span class="text-white font-light">Pro</span></h2>
            <button onclick="confirmReset()" class="text-[10px] bg-rose-500/20 text-rose-400 px-3 py-1 rounded-full border border-rose-500/30 hover:bg-rose-500 hover:text-white transition-all">
                <i class="fas fa-undo mr-1"></i>é‡è¨­å…§å®¹
            </button>
        </div>

        <section class="bg-slate-900/50 p-5 rounded-2xl space-y-4 border border-slate-700/50">
            <div class="flex items-center justify-between px-1">
                <p class="text-[10px] font-black text-blue-400 uppercase tracking-widest">é–‹ç™¼ç¥¨ (5% ç‡Ÿæ¥­ç¨…)</p>
                <input type="checkbox" id="tax_switch" class="w-5 h-5 accent-blue-500 cursor-pointer" onchange="calculateTotal()">
            </div>
            <input type="text" id="in_name" placeholder="å®¢æˆ¶å§“å (ç”²æ–¹)" class="sidebar-input" oninput="sync()">
            <input type="text" id="in_addr" placeholder="å·¥ç¨‹åç¨± / æ–½å·¥åœ°é»" class="sidebar-input" oninput="sync()">
        </section>

        <section class="space-y-3">
            <p class="text-[10px] font-black text-slate-500 uppercase tracking-widest px-1">è«‹æ¬¾é …ç›®ç®¡ç†</p>
            <div class="grid grid-cols-2 gap-3">
                <button onclick="addBillRow('', 0)" class="bg-blue-600 hover:bg-blue-500 py-3 rounded-2xl text-xs font-black shadow-lg shadow-blue-900/40 transition-all">+ æ–°å¢é …ç›®</button>
                <button onclick="document.getElementById('file1').click()" class="bg-slate-700 hover:bg-slate-600 py-3 rounded-2xl text-xs font-black transition-all">ğŸ“¸ ä¸Šå‚³ç…§ç‰‡</button>
            </div>
            <input type="file" id="file1" hidden accept="image/*" onchange="previewImg(this)">
        </section>

        <section class="space-y-3">
            <p class="text-[10px] font-black text-slate-500 uppercase tracking-widest px-1">å‚™è¨»èªªæ˜</p>
            <textarea id="in_note" rows="3" class="sidebar-input text-xs" oninput="sync()" placeholder="ä¾‹å¦‚ï¼šæœ¬æ¬¡è«‹æ¬¾ç‚ºç¬¬ä¸€æœŸè¨‚é‡‘..."></textarea>
        </section>

        <button onclick="saveToSupabase()" id="btnSync" class="w-full bg-emerald-600 hover:bg-emerald-500 text-white py-4 rounded-2xl font-black text-lg shadow-xl transition-all active:scale-95">
            <i class="fas fa-cloud-upload-alt mr-2"></i> åŒæ­¥è‡³é›²ç«¯ç³»çµ±
        </button>

        <button onclick="window.print()" class="w-full bg-white text-slate-900 py-4 rounded-2xl font-black text-lg shadow-xl transition-all">
            <i class="fas fa-print mr-2"></i> åˆ—å° / å­˜ç‚º PDF
        </button>
    </aside>

    <main class="main-content">
        <div class="a4-preview">
            <div class="flex justify-between items-end border-b-4 border-slate-900 pb-4 mb-10">
                <div>
                    <h1 class="text-4xl font-black italic tracking-tighter text-slate-900">INVOICE è«‹æ¬¾å–®</h1>
                    <p class="text-[10px] font-bold text-slate-400">éŒ¦å¾·é˜²æ°´å·¥ç¨‹è¡Œ JINDE WATERPROOFING</p>
                </div>
                <div class="text-right text-[10px] font-mono leading-tight">
                    <p>ç·¨è™Ÿ: <span id="out_id" class="font-bold"></span></p>
                    <p>æ—¥æœŸ: <span id="out_date" class="font-bold"></span></p>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-6 mb-10">
                <div class="border-l-8 border-blue-600 pl-4 py-2 bg-slate-50 rounded-r-2xl">
                    <p class="text-[9px] text-slate-400 font-black uppercase">Billing To (ç”²æ–¹)</p>
                    <p id="out_name" class="font-black text-xl text-slate-800">æœªå¡«å¯«å®¢æˆ¶</p>
                    <p id="out_addr" class="text-xs font-bold text-slate-500 mt-1">æœªå¡«å¯«æ–½å·¥åœ°å€</p>
                </div>
                <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100 shadow-sm text-[11px]">
                    <p class="text-[9px] font-black text-slate-400 uppercase mb-2 tracking-widest">Payment Info åŒ¯æ¬¾è³‡è¨Š</p>
                    <div class="space-y-1 font-bold">
                        <div class="flex justify-between border-b pb-1"><span>éŠ€è¡Œåç¨±</span><span>XXéŠ€è¡Œ (000)</span></div>
                        <div class="flex justify-between border-b pb-1"><span>å¸³æˆ¶åç¨±</span><span>éŒ¦å¾·é˜²æ°´å·¥ç¨‹è¡Œ</span></div>
                        <div class="flex justify-between text-blue-700"><span>åŒ¯æ¬¾å¸³è™Ÿ</span><span class="font-mono text-xs">1234-567-890123</span></div>
                    </div>
                </div>
            </div>

            <table class="w-full mb-6">
                <thead>
                    <tr class="bg-slate-900 text-white text-[10px] font-black uppercase tracking-widest">
                        <th class="py-4 pl-4 text-left rounded-l-lg">Description è«‹æ¬¾é …ç›®èªªæ˜</th>
                        <th class="py-4 text-right pr-4 rounded-r-lg w-48">Amount é‡‘é¡ (TWD)</th>
                    </tr>
                </thead>
                <tbody id="billTable" class="divide-y divide-slate-100 text-slate-800 font-bold">
                    </tbody>
            </table>

            <div class="flex justify-end mb-10">
                <div class="w-80 space-y-2 bg-slate-50 p-5 rounded-3xl">
                    <div class="flex justify-between text-sm text-slate-500 font-bold"><span>å°è¨ˆ (æœªç¨…):</span><span id="tax_sub">0</span></div>
                    <div id="tax_row" class="flex justify-between text-sm text-rose-500 font-bold hidden"><span>ç‡Ÿæ¥­ç¨… (5%):</span><span id="tax_val">0</span></div>
                    <div class="flex justify-between border-t border-slate-200 pt-2 text-2xl font-black text-slate-900 italic">
                        <span>Total:</span><span>NT$ <span id="tax_total">0</span></span>
                    </div>
                    <p class="text-[10px] text-slate-400 font-black text-right pt-2 uppercase italic tracking-wider">
                        å¤§å¯«ï¼š<span id="chineseAmount" class="text-slate-900 ml-1">é›¶å…ƒæ•´</span>
                    </p>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-10 mt-auto">
                <div class="space-y-4">
                    <h4 class="text-[10px] font-black bg-slate-900 text-white px-3 py-1.5 rounded-lg w-fit uppercase">å‚™è¨»äº‹é … Note</h4>
                    <pre id="out_note" class="text-xs text-slate-600 font-bold whitespace-pre-wrap leading-relaxed"></pre>
                    <div class="h-44 bg-slate-50 border-2 border-dashed border-slate-200 rounded-3xl flex items-center justify-center overflow-hidden">
                        <img id="p1" class="hidden w-full h-full object-cover">
                        <span class="text-[10px] text-slate-300 font-black uppercase">Site Photo / ç¾å ´åœ–</span>
                    </div>
                </div>
                <div class="flex flex-col justify-end space-y-12 pb-4">
                    <div class="text-right">
                        <p class="text-[9px] font-black text-slate-300 uppercase mb-8">Authorized Signature</p>
                        <p class="font-black text-sm border-b-2 border-slate-900 pb-2 inline-block w-48">éŒ¦å¾·é˜²æ°´å·¥ç¨‹è¡Œ (ç°½ç« )</p>
                    </div>
                    <div class="text-right">
                        <p class="text-[9px] font-black text-slate-300 uppercase mb-8">Client Confirmation</p>
                        <p class="font-bold text-sm text-slate-300 italic border-b-2 border-slate-100 pb-2 inline-block w-48">æ¥­ä¸»å›ç°½ Signature</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // --- Supabase è¨­ç½® ---
        const S_URL = 'https://wdpxgichzvfebhlukbrl.supabase.co';
        const S_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndkcHhnaWNoenZmZWJobHVrYnJsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkwMjExMzQsImV4cCI6MjA4NDU5NzEzNH0.--85I0A-7WKt0P-ex1Zdnb8UVspuMNshzQtNaLedKq0';
        const _supabase = supabase.createClient(S_URL, S_KEY);

        window.onload = () => { resetDoc(); };

        function resetDoc() {
            const now = new Date();
            document.getElementById('out_date').innerText = now.toLocaleDateString('zh-TW');
            document.getElementById('out_id').innerText = "INV-" + now.getFullYear() + (now.getMonth()+1).toString().padStart(2,'0') + now.getDate().toString().padStart(2,'0') + "-" + Math.floor(Math.random()*900+100);
            document.getElementById('billTable').innerHTML = "";
            addBillRow("å·¥ç¨‹é€²åº¦æ¬¾ (ç¬¬ä¸€æœŸæ¬¾)", 0);
            sync();
        }

        function goHome() { if(confirm("ç¢ºå®šè¿”å›ä¸»é¸å–®ï¼ŸæœªåŒæ­¥çš„è³‡æ–™æœƒéºå¤±ã€‚")) location.href = 'index.html'; }
        
        function confirmReset() { if(confirm("ç¢ºå®šè¦é‡è¨­å…¨å–®ï¼Ÿ")) { document.getElementById('in_name').value = ""; document.getElementById('in_addr').value = ""; document.getElementById('tax_switch').checked = false; document.getElementById('p1').src = ""; document.getElementById('p1').classList.add('hidden'); resetDoc(); } }

        function sync() {
            document.getElementById('out_name').innerText = document.getElementById('in_name').value || "æœªå¡«å¯«å®¢æˆ¶";
            document.getElementById('out_addr').innerText = document.getElementById('in_addr').value || "æœªå¡«å¯«æ–½å·¥åœ°å€";
            document.getElementById('out_note').innerText = document.getElementById('in_note').value;
            calculateTotal();
        }

        function addBillRow(name, amount) {
            const tbody = document.getElementById('billTable');
            const tr = document.createElement('tr');
            tr.className = "group transition-all hover:bg-slate-50/50";
            tr.innerHTML = `
                <td class="py-5 pl-4"><input type="text" value="${name}" class="billing-input text-lg font-black text-slate-800" oninput="calculateTotal()"></td>
                <td class="py-5 text-right pr-4"><input type="number" value="${amount}" class="billing-input text-right font-mono text-2xl text-blue-600 item-price" oninput="calculateTotal()" onfocus="this.select()"></td>
                <td class="no-print w-8 text-center"><button onclick="this.closest('tr').remove(); calculateTotal();" class="text-slate-300 hover:text-rose-500 transition-all text-sm">âœ•</button></td>
            `;
            tbody.appendChild(tr);
            calculateTotal();
        }

        function calculateTotal() {
            let subtotal = 0;
            document.querySelectorAll('.item-price').forEach(input => {
                subtotal += parseFloat(input.value) || 0;
            });

            const isTax = document.getElementById('tax_switch').checked;
            const taxAmount = isTax ? Math.round(subtotal * 0.05) : 0;
            const finalTotal = subtotal + taxAmount;

            document.getElementById('tax_sub').innerText = subtotal.toLocaleString();
            document.getElementById('tax_val').innerText = taxAmount.toLocaleString();
            document.getElementById('tax_total').innerText = finalTotal.toLocaleString();
            document.getElementById('chineseAmount').innerText = numberToChinese(finalTotal);
            
            if(isTax) document.getElementById('tax_row').classList.remove('hidden');
            else document.getElementById('tax_row').classList.add('hidden');
        }

        async function saveToSupabase() {
            const finalAmount = parseFloat(document.getElementById('tax_total').innerText.replace(/,/g, ''));
            const cName = document.getElementById('in_name').value.trim();
            if(!cName) return alert("è«‹è¼¸å…¥å®¢æˆ¶å§“åã€‚");
            if(finalAmount <= 0) return alert("è«‹è¼¸å…¥æ­£ç¢ºé‡‘é¡ã€‚");

            const btn = document.getElementById('btnSync');
            btn.disabled = true;
            btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> åŒæ­¥ä¸­...`;

            try {
                const { error } = await _supabase.from('billings').insert([{
                    "bill_id": document.getElementById('out_id').innerText,
                    "customer_name": cName,
                    "project_name": document.getElementById('in_addr').value,
                    "final_amount": finalAmount,
                    "note": document.getElementById('in_note').value
                }]);
                if (error) throw error;
                alert('âœ… åŒæ­¥æˆåŠŸï¼é›²ç«¯è³‡æ–™åº«å·²å­˜æª”ã€‚');
            } catch (e) {
                alert('âŒ åŒæ­¥å¤±æ•—ï¼š' + e.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = `<i class="fas fa-cloud-upload-alt mr-2"></i> åŒæ­¥è‡³é›²ç«¯ç³»çµ±`;
            }
        }

        function previewImg(input) {
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = e => {
                    const img = document.getElementById('p1');
                    img.src = e.target.result;
                    img.classList.remove('hidden');
                    img.nextElementSibling.classList.add('hidden');
                };
                reader.readAsDataURL(file);
            }
        }

        function numberToChinese(n) {
            if (n === 0) return "é›¶å…ƒæ•´";
            const digit = ['é›¶', 'å£¹', 'è²³', 'åƒ', 'è‚†', 'ä¼', 'é™¸', 'æŸ’', 'æŒ', 'ç–'];
            const unit = [['å…ƒ', 'è¬', 'å„„'], ['', 'æ‹¾', 'ä½°', 'ä»Ÿ']];
            let s = 'æ•´'; n = Math.floor(n);
            for (let i = 0; i < unit[0].length && n > 0; i++) {
                let p = '';
                for (let j = 0; j < unit[1].length && n > 0; j++) {
                    p = digit[n % 10] + (n % 10 !== 0 ? unit[1][j] : '') + p;
                    n = Math.floor(n / 10);
                }
                s = p.replace(/(é›¶.)*é›¶$/, '').replace(/^$/, 'é›¶') + unit[0][i] + s;
            }
            return s.replace(/(é›¶.)*é›¶å…ƒ/, 'å…ƒ').replace(/(é›¶.)+/g, 'é›¶').replace(/^å…ƒ/, "é›¶å…ƒ");
        }
    </script>
</body>
</html>
