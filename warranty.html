<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>JINDE | 保固書內頁生產</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/pocketbase/dist/pocketbase.umd.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700;900&family=Noto+Sans+TC:wght@400;700&display=swap');
        body { background-color: #0f172a; margin: 0; padding: 0; }
        @page { size: A4; margin: 0; }

        .admin-panel {
            position: fixed; left: 20px; top: 20px; width: 340px; height: calc(100vh - 40px);
            background: rgba(30, 41, 59, 0.95); backdrop-filter: blur(10px);
            border-radius: 24px; padding: 25px; z-index: 1000; border: 1px solid rgba(255,255,255,0.1);
            overflow-y: auto; color: white;
        }

        .a4-page {
            width: 210mm; height: 297mm; padding: 25mm 22mm; margin: 20px auto 20px 400px;
            background: white; font-family: 'Noto Serif TC', serif; color: #1a1a1a;
            position: relative; box-sizing: border-box; box-shadow: 0 0 50px rgba(0,0,0,0.5);
        }

        .back-home {
            display: flex; align-items: center; gap: 8px; color: #94a3b8;
            font-size: 0.875rem; font-weight: 600; margin-bottom: 1.5rem;
            transition: all 0.3s; cursor: pointer; text-decoration: none;
        }
        .back-home:hover { color: #2dd4bf; transform: translateX(-4px); }

        .page-header { border-bottom: 2px solid #000; padding-bottom: 8px; display: flex; justify-content: space-between; align-items: flex-end; }
        .main-title { font-size: 38pt; font-weight: 900; text-align: center; margin: 35pt 0; letter-spacing: 0.5em; }
        .content-body { font-size: 14.5pt; line-height: 2.2; text-align: justify; margin-bottom: 25pt; }
        .underline-input { font-weight: 700; border-bottom: 2px solid #000; padding: 0 10px; display: inline-block; min-width: 150px; text-align: center; }
        table { width: 100%; border-collapse: collapse; }
        td { border: 1.5pt solid #000; padding: 12pt; font-size: 13pt; }
        .bg-gray { background-color: #f5f5f5; font-weight: 700; width: 125px; text-align: center; }

        #logo_preview { position: absolute; top: 45mm; right: 22mm; max-width: 55mm; max-height: 25mm; display: none; }
        #seal_preview { position: absolute; bottom: 95px; right: 145px; width: 145px; display: none; transform: rotate(-8deg); z-index: 10; }
        
        @media print {
            body { background: none; }
            .no-print { display: none !important; }
            .a4-page { margin: 0 auto; box-shadow: none; }
        }
    </style>
</head>
<body>
    <div class="no-print admin-panel">
        <a href="index.html" class="back-home">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
            Back Home / 返回首頁
        </a>

        <h2 class="text-2xl font-black mb-5 text-teal-400">內頁生產器</h2>
        
        <div class="space-y-4">
            <div class="grid grid-cols-2 gap-2">
                <div><label class="text-[10px] text-slate-400 font-bold">1. 公司 Logo</label><input type="file" class="w-full text-[10px]" onchange="loadFile(event, 'logo_preview')"></div>
                <div><label class="text-[10px] text-red-400 font-bold">2. 公司印章</label><input type="file" class="w-full text-[10px]" onchange="loadFile(event, 'seal_preview')"></div>
            </div>
            <hr class="border-slate-700">
            <div><label class="text-xs text-slate-400 font-bold">客戶姓名</label><input type="text" id="in_client" value="王大明 先生" class="w-full bg-slate-800 rounded p-3 text-sm mt-1 focus:border-teal-500 outline-none" oninput="sync()"></div>
            <div><label class="text-xs text-slate-400 font-bold">案場名稱</label><input type="text" id="in_p_name" value="台中市北屯區山西路二段 250 號" class="w-full bg-slate-800 rounded p-3 text-sm mt-1 focus:border-teal-500 outline-none" oninput="sync()"></div>
            <div><label class="text-xs text-slate-400 font-bold">保固期限 (年)</label><input type="number" id="in_years" value="3" class="w-full bg-slate-800 rounded p-3 text-sm mt-1 focus:border-teal-500 outline-none" oninput="sync()"></div>
            
            <div class="pt-4">
                <button onclick="saveAndPrint()" class="w-full bg-gradient-to-r from-teal-500 to-blue-600 py-4 rounded-xl font-black text-lg shadow-xl hover:opacity-90 transform active:scale-95 transition-all">列印並存入雲端</button>
                <p id="status_msg" class="text-[10px] text-center mt-2 text-slate-500"></p>
            </div>
        </div>
    </div>

    <div class="a4-page">
        <div class="page-header">
            <div class="text-[13pt] font-semibold tracking-[0.6em]">專 業 · 態 度 · 細 心 · 責 任</div>
            <div class="text-sm italic text-gray-400 font-sans text-right">JINDE WATERPROOFING</div>
        </div>
        <div class="border-b border-black mt-1 mb-12"></div>
        
        <img id="logo_preview" src="">
        <h1 class="main-title">服務保固書</h1>

        <div class="content-body">
            茲承攬 <span id="out_client" class="underline-input"></span> 之 <span id="out_p_name" class="underline-input"></span> 防水修繕工程。本公司承諾對施工品質負完全責任，若於保固期間內發生施工瑕疵導致之滲漏，本公司將負責無償修繕完成。
        </div>

        <table>
            <tr><td class="bg-gray">保固期限</td><td colspan="3" class="font-bold">自民國 <span class="d_y"></span> 年 <span class="d_m"></span> 月 <span class="d_d"></span> 日起，共計 <span id="out_years">3</span> 年。</td></tr>
            <tr><td class="bg-gray">承攬廠商</td><td class="text-xl font-black">錦德工程行</td><td class="bg-gray">統一編號</td><td class="font-bold">88889999</td></tr>
            <tr><td class="bg-gray">負責人</td><td class="text-lg">陳錦德</td><td class="bg-gray">聯絡電話</td><td class="font-bold">04-2247-XXXX</td></tr>
            <tr><td class="bg-gray">通訊地址</td><td colspan="3">台中市北屯區山西路二段 250 號</td></tr>
        </table>

        <div class="absolute bottom-[35mm] left-[22mm] flex items-center gap-4">
            <div class="border border-black p-1 bg-white"><img id="qr_img" src="" class="w-20 h-20"></div>
            <div class="text-[9pt] leading-relaxed">數位保固驗證系統<br>核發編號：<span id="doc_id" class="font-mono font-bold"></span><br><span class="text-gray-400">Quality Authenticated</span></div>
        </div>

        <img id="seal_preview" src="">

        <div class="absolute bottom-[35mm] right-[22mm] text-right">
            <p class="font-bold text-lg mb-20 text-gray-200">業主簽署處：____________________</p>
            <p class="font-black text-2xl tracking-tighter">中 華 民 國 <span class="d_y"></span> 年 <span class="d_m"></span> 月 <span class="d_d"></span> 日</p>
        </div>
        <div class="absolute bottom-[10mm] left-0 right-0 text-center font-sans text-gray-300 text-sm tracking-[0.5em]">QUALITY ASSURANCE DOCUMENT</div>
    </div>

    <script>
        // 初始化 PocketBase 連線
        const pb = new PocketBase('https://unoppressed-nonanimate-albertina.ngrok-free.dev');
        const COLLECTION_ID = 'WarrantyRecords'; // 您的新資料表名稱

        function loadFile(event, targetId) {
            const output = document.getElementById(targetId);
            if(event.target.files[0]) {
                output.src = URL.createObjectURL(event.target.files[0]);
                output.style.display = 'block';
            }
        }

        async function saveAndPrint() {
            const statusEl = document.getElementById('status_msg');
            statusEl.innerText = "⏳ 正在同步雲端...";
            
            const data = {
                "client_name": document.getElementById('in_client').value,
                "project_name": document.getElementById('in_p_name').value,
                "warranty_id": document.getElementById('doc_id').innerText,
                "years": parseInt(document.getElementById('in_years').value),
                "status": "已列印"
            };

            try {
                // 存入新表 WarrantyRecords
                await pb.collection(COLLECTION_ID).create(data);
                statusEl.innerText = "✅ 雲端歸檔成功";
                statusEl.classList.add('text-teal-400');
            } catch (err) {
                console.error("歸檔失敗:", err);
                statusEl.innerText = "❌ 歸檔失敗 (API未解鎖)";
                statusEl.classList.add('text-red-400');
            }
            
            // 無論是否存成功，都觸發列印視窗
            setTimeout(() => { window.print(); }, 500);
        }

        function sync() {
            document.getElementById('out_client').innerText = document.getElementById('in_client').value;
            document.getElementById('out_p_name').innerText = document.getElementById('in_p_name').value;
            document.getElementById('out_years').innerText = document.getElementById('in_years').value;
            
            // 固定隨機種子，避免每次輸入都在變
            if(!window.currentId) {
                window.currentId = "JD-" + Math.random().toString(36).substr(2, 7).toUpperCase();
            }
            
            const id = window.currentId;
            document.getElementById('doc_id').innerText = id;
            document.getElementById('qr_img').src = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(window.location.href + '?id=' + id)}`;
            
            const now = new Date();
            const y = now.getFullYear() - 1911;
            const m = now.getMonth() + 1;
            const d = now.getDate();
            document.querySelectorAll('.d_y').forEach(el => el.innerText = y);
            document.querySelectorAll('.d_m').forEach(el => el.innerText = m);
            document.querySelectorAll('.d_d').forEach(el => el.innerText = d);
        }
        window.onload = sync;
    </script>
</body>
</html>
